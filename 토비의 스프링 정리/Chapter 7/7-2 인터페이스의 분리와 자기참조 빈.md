# 7.2 ì¸í„°í˜ì´ìŠ¤ì˜ ë¶„ë¦¬ì™€ ìê¸°ì°¸ì¡° ë¹ˆ

7.2.1 JAXB(Java Architecture for XML Binding)

- XMLì— ë‹´ê¸´ ì •ë³´ë¥¼ íŒŒì¼ì— ì½ì–´ì˜¤ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜
- JAXBëŠ” DOMê³¼ ê³¼ ê°™ì€ ì „í†µì ì¸ XML APIì™€ ë¹„êµí–ˆì„ ë•Œ, XML ë¬¸ì„œì •ë³´ë¥¼ ê±°ì˜ ë™ì¼í•œ êµ¬ì¡°ì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ì§ì ‘ ë§¤ì¹­í•´ì¤Œ
- DOMì€ XML ì •ë³´ë¥¼ ë§ˆì¹˜ ìë°”ì˜ ë¦¬í”Œë ‰ì…˜ APIë¥¼ ì‚¬ìš©í•´ ì¡°ì‘ í•˜ëŠ”ê²ƒ ì²˜ëŸ¼ **ê°„ì ‘ì **ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•¨
- JAXBëŠ” XMLì˜ ì •ë³´ë¥´ ê·¸ëŒ€ë¡œ ë‹´ê³  ìˆëŠ”ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ê¸° ë•Œë¬¸ì—, XML ì •ë³´ë¥¼ ì˜¤ë¸Œì íŠ¸ ì²˜ëŸ¼ **ì§ì ‘ì **ìœ¼ë¡œ ë‹¤ë£° ìˆ˜ ìˆì–´ í¸ë¦¬í•¨
- JAXBëŠ” XML ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ì •ì˜í•œ ìŠ¤í‚¤ë§ˆë¥¼ ì´ìš©í•´ì„œ ë§¤í•‘í•  ì˜¤ë¸Œì íŠ¸ì˜ í´ë˜ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” **ì»´íŒŒì¼ëŸ¬**ë„ ì œê³µí•¨
- **ìŠ¤í‚¤ë§ˆ ì»´íŒŒì¼ëŸ¬**ë¥¼ í†µí•´ ìë™ìƒì„± ëœ ì˜¤ë¸Œì íŠ¸ì—ëŠ” ë§¤í•‘ì •ë³´ê°€ **ì• ë…¸í…Œì´ì…˜**ìœ¼ë¡œ ë‹´ê²¨ ìˆìŒ
- JAXB APIëŠ” ì• ë…¸í…Œì´ì…˜ì— ë‹´ê¸´ ì •ë³´ë¥¼ ì´ìš©í•´ XMLê³¼ ë§¤í•‘ê´¸ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ ì‚¬ì´ì˜ ìë™ë³€í™˜ ì‘ì—…ì„ ìˆ˜í–‰í•¨

![https://dhsim86.github.io/static/assets/img/blog/web/2017-10-10-toby_spring_07_core_apply/00.png](https://dhsim86.github.io/static/assets/img/blog/web/2017-10-10-toby_spring_07_core_apply/00.png)

7.2.2 SQL ë§µì„ ìœ„í•œ ìŠ¤í‚¤ë§ˆ ì‘ì„±ê³¼ ì»´íŒŒì¼

- <sqlmap>, <sql> êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ” ìŠ¤í‚¤ë§ˆ ìƒì„±
- ìŠ¤í‚¤ë§ˆ ì´ë¦„ì€ sqlmap.xsd

```groovy
// https://mvnrepository.com/artifact/javax.xml.bind/jaxb-api
implementation group: 'javax.xml.bind', name: 'jaxb-api', version: '2.3.1'
```

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<schema xmlns="http://www.w3.org/2001/XMLSchema"
        targetNamespace="http://www.epril.com/sqlmap"
        xmlns:tns="http://www.epril.com/sqlmap" elementFormDefault="qualified">

    <element name="sqlmap">
        <complexType>
            <sequence>
                <!--unbounded : í•„ìš”í•œ ê°œìˆ˜ë§Œí¼ <sql>ì„ í¬í•¨í•  ìˆ˜ ìˆê²Œ í•¨-->
                <element name="sql" maxOccurs="unbounded" type="tns:sqlType"/>
            </sequence>
        </complexType>
    </element>
    
    <!--<sql>ì— ëŒ€í•œ ì •ì˜ ì‹œì‘-->
    <complexType name="sqlType">
        <simpleContent>
            <!--SQL ë¬¸ì¥ì„ ë„£ì„ ìŠ¤íŠ¸ë§ íƒ€ì… ì§€ì •-->
            <extension base="string">
                <!--ê²€ìƒ‰ì„ ìœ„í•œ í‚¤ ê°’ì€ <sql>ì˜ key ì• íŠ¸ë¦¬ë·°íŠ¸ì— ë„£ìŒ. í•„ìˆ˜ê°’ì„-->
                <attribute name="key" use="required" type="string"/>
            </extension>
        </simpleContent>
    </complexType>
    
</schema>
```

- **ì…¸** ë˜ëŠ” **ë„ìŠ¤** ì°½ì—ì„œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”ë¡œ ì´ë™í•œ ë’¤ ë‹¤ìŒ ëª…ë ¹ì–´ ì‚¬ìš©í•´ ì»´íŒŒì¼

```bash
xjc -p {íŒ¨í‚¤ì§€ì´ë¦„} {ë³€í™˜í•  ìŠ¤í‚¤ë§ˆ íŒŒì¼} -d {ìƒì„±ëœ íŒŒì¼ì´ ì €ì¥ë  ìœ„ì¹˜}

xjc -p com.ksb.spring.jaxb sqlmap.xsd -d src
```

<aside>
ğŸ’¡ í˜„ì¬ ëª…ë ¹ì–´ ì‹¤í–‰ ë¶ˆê°€!!

</aside>

7.2.3 ì±… ë‚´ìš©ì˜ ë¬¸ì œì  ë° ëŒ€ì•ˆë°©ë²•

- í† ë¹„ì˜ ìŠ¤í”„ë§ ì±…ì´ ë°œê°„ëœì§€ ì˜¤ë˜ëìŒ ë•Œë¬¸ì— ë ˆê±°ì‹œ ë¬¸ì œê°€ ìˆìŒ
- ë˜í•œ, ê³¼ê±°ì—ëŠ” ì§€ì› í–ˆìœ¼ë‚˜ í˜„ì¬ëŠ” ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ëŠ¥ë“¤ì´ ì¡´ì¬í•¨
- JAXBê°€ ëŒ€í‘œì ì¸ ì˜ˆì‹œì„
- ê¸°ì¡´ JDKì— ì¡´ì¬í•˜ëŠ” JABX ìŠ¤í‚¤ë§ˆ ì»´íŒŒì¼ëŸ¬ê°€ JDK 11ë¶€í„° ì‚¬ë¼ì¡ŒìŒ
- ë•Œë¬¸ì—, ì±…ì—ì„œ ë‚˜ì˜¨ ëª…ë ¹ì–´ë¥¼ í†µí•œ [JABX ì»´íŒŒì¼ëŸ¬ ì‹¤í–‰](https://han-jinkyu.tistory.com/14)ì€ ë”°ë¡œ JAXB ìŠ¤í‚¤ë§ˆ ì»´íŒŒì¼ëŸ¬ë¥¼ ë°›ì•„ ì‹¤í–‰ì‹œí‚¤ì§€ ì•ŠëŠ” ì´ìƒ ë¶ˆê°€ëŠ¥í•¨
    
    <aside>
    ğŸ’¡ ë³„ë„ë¡œ JAXB ìŠ¤í‚¤ë§ˆ ì»´íŒŒì¼ëŸ¬ë¥¼ ë°›ì•„ì„œ ì‹œë„ í•´ ë´¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŒ
    
    </aside>
    
- [ëŒ€ì•ˆë°©ë²•](https://www.jetbrains.com/help/idea/generating-java-code-from-xml-schema.html)ì€ ì¡´ì¬í•¨(IntellJ Ultimate ì‚¬ìš©ìë§Œ ê°€ëŠ¥!)
    1. ë³€í™˜í•˜ê³ ì í•˜ëŠ” xsd íŒŒì¼ë¡œ ì´ë™
    2. IntelliJì—ì„œ Ctrl+ALT+A ë¥¼ ë™ì‹œì— ëˆ„ë¥´ê¸°
    3. JAXB ê²€ìƒ‰
    4. Generate Java Code From XML Schema Using XMLBeans ì„ íƒ
    5. ì›í•˜ëŠ” í•­ëª© ì±„ì›Œë„£ê³  ì—”í„° ëˆ„ë¥´ë©´ íŒŒì¼ì´ ìƒê¹€
- sqlmap.xsdì—ì„œ ì‹¤í–‰ì‹œ Sqlmap, SqlType í´ë˜ìŠ¤ ìƒì„±

```java
//ë³€í™˜ ì‘ì—…ì—ì„œ ì°¸ê³ í•  ì •ë³´ë¥¼ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê°–ê³ ìˆìŒ
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "", propOrder = {
    "sql"
})
@XmlRootElement(name = "sqlmap", namespace = "http://www.epril.com/sqlmap")
public class Sqlmap {
    @XmlElement(namespace = "http://www.epril.com/sqlmap", required = true)
    protected List<SqlType> sql
    public List<SqlType> getSql() {
        if (sql == null) {
            sql = new ArrayList<SqlType>();
        }
        return this.sql;
    }

}

@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "sqlType", namespace = "http://www.epril.com/sqlmap", propOrder = {
    "value"
})
public class SqlType { // <sql> íƒœê·¸ í•œ ê°œë‹¹ SqlType ì˜¤ë¸Œì íŠ¸ í•˜ë‚˜ ì”© ìƒì„±
    @XmlValue
    protected String value; //SQL ê°’ì„ ì €ì¥í•  ìŠ¤íŠ¸ë§ íƒ€ì… í•„ë“œ
    @XmlAttribute(name = "key", required = true)
    protected String key; //ê²€ìƒ‰ìš© í‚¤ ê°’
    public String getValue() {
        return value;
    }
    public void setValue(String value) {
        this.value = value;
    }
    public String getKey() {
        return key;
    }
    public void setKey(String value) {
        this.key = value;
    }
}
```

7.2.4 ì–¸ë§ˆìƒ¬ë§ ë° í•™ìŠµ í…ŒìŠ¤íŠ¸

- XML ë¬¸ì„œë¥¼ ì½ì–´ì„œ ìë°”ì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ì‘ì—…ì„ JAXBì—ì„œëŠ” **ì–¸ë§ˆìƒ¬ë§(Unmarshalling)**ì´ë¼ í•¨
- ì´ì™€ ëŒ€ì¡°ì ìœ¼ë¡œ, ë°”ì¸ë”© ì˜¤ë¸Œì íŠ¸ë¥¼ XML ë¬¸ì„œë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì„ **ë§ˆìƒ¬ë§(Marshalling)**ì´ë¼ í•¨
- JABX APIë¥¼ ì´ìš©í•´ ì–¸ë§ˆìƒ¬ë§ì´ ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ í•  ê²ƒì„
- í…ŒìŠ¤íŠ¸ìš© SQL ë§µ XML ë¬¸ì„œ ì´ë¦„ sqlmap.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<sqlmap xmlns="http://www.epril.com/sqlmap"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.epril.com/sqlmap  ./sqlmap.xsd">
    <sql key="add">insert</sql>
    <sql key="get">select</sql>
    <sql key="delete">delete</sql>
</sqlmap>
```

```java
import com.ksb.spring.jaxb.SqlType;
import com.ksb.spring.jaxb.Sqlmap;
...

public class JaxbTest {
    @Test
    public void readSqlmap() throws JAXBException, IOException {
        //ë°”ì¸ë”©ìš© í´ë˜ìŠ¤ë“¤ ìœ„ì¹˜ë¥¼ ê°€ì§€ê³  JAXB ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“¦
        String contextPath = Sqlmap.class.getPackage().getName();
        JAXBContext context = JAXBContext.newInstance(contextPath);
        
        //ì–¸ë§ˆìƒ¬ëŸ¬ ìƒì„±. xml -> ìë°” ì˜¤ë¸Œì íŠ¸
        Unmarshaller unmarshaller = context.createUnmarshaller();

        //ì–¸ë§ˆìƒ¬ì„ í•˜ë©´ ë§¤í•‘ëœ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ì˜ ë£¨íŠ¸ì¸ Sqlmapì„ ë°˜í™˜
        Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal(
                getClass().getResourceAsStream("sqlmap.xml")
        );

        //Listì— ë‹´ê²¨ ìˆëŠ” Sql ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì™€ XML ë¬¸ì„œì™€ ê°™ì€ ì •ë³´ë¥¼ ê°–ëŠ”ì§€ í™•ì¸
        List<SqlType> sqlList = sqlmap.getSql();

        assertThat(sqlList.size() ,is(3));
        assertThat(sqlList.get(0).getKey(), is("add"));
        assertThat(sqlList.get(0).getValue(), is("insert"));
        assertThat(sqlList.get(1).getKey(), is("get"));
        assertThat(sqlList.get(1).getValue(), is("select"));
        assertThat(sqlList.get(2).getKey(), is("delete"));
        assertThat(sqlList.get(2).getValue(), is("delete"));
    }
}
```

7.2.5 SQL ë§µ XML íŒŒì¼

- UserDaoJdbcì— ì‚¬ìš©í•  SQLì´ ë‹´ê¸´ XML ë¬¸ì„œ ìƒì„± í•  ê²ƒì„
- ìŠ¤í”„ë§ ì„¤ì •ì˜ <map>, <entry>ì— ë‹´ì•„ë’€ì„ ë•Œ ë³´ë‹¤ ì˜ë¯¸ê°€ ëª…í™•í•¨
- SQLì€ DAOì˜ ë¡œì§ ì¼ë¶€ì´ê¸° ë•Œë¬¸ì— ê°™ì€ íŒ¨í‚¤ì§€ì— ë‘ëŠ”ê²ƒì´ ì¢‹ìŒ
- ìœ„ì—ì„œ ë§Œë“  sqlmap.xmlì„ ìˆ˜ì •

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<sqlmap xmlns="http://www.epril.com/sqlmap"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.epril.com/sqlmap  ./sqlmap.xsd">
    <sql key="userAdd">insert into users(id, name, password, level, login, recommend) value (?,?,?,?,?,?)</sql>
    <sql key="userGet">select * from users where id = ?</sql>
    <sql key="userGetAll">select * from users order by id</sql>
    <sql key="userDeleteAll">delete from users</sql>
    <sql key="userGetCount">select count(*) from users</sql>
    <sql key="userUpdate">update users set name=?, password=?, level=?, login=?, recommend=? where id=?</sql>
</sqlmap>
```

7.2.6 XML SQL ì„œë¹„ìŠ¤

- sqlmap.xmlì— ìˆëŠ” SQLì„ ê°€ì ¸ì™€ DAOì— ì œê³µí•˜ëŠ” SqlService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ ê²ƒì„
- ì–¸ì œ JAXBë¥¼ ì´ìš©í•´ XML ë¬¸ì„œë¥¼ ê°€ì ¸ì˜¬ì§€ ìƒê°í•´ë´ì•¼ í•¨
- DAOê°€ SQL ìš”ì²­ í•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ XML íŒŒì¼ì„ ì½ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì„
- íŠ¹ë³„í•œ ì´ìœ ê°€ ì—†ëŠ” í•œ, XML íŒŒì¼ì€ í•œ ë²ˆë§Œ ì½ë„ë¡ í•´ì•¼ í•¨
- XML íŒŒì¼ë¡œ ë¶€í„° ì½ì€ ë‚´ìš©ì€ ì–´ë”˜ê°€ì— ì €ì¥í•´ë‘ê³  DAOì— ìš”ì²­ì´ ì˜¬ ë•Œ ì‚¬ìš©ë˜ì•¼ í•¨
- ì²˜ìŒ SQLì„ì½ëŠ” ê±´ ì–´ë””ì„œ í•´ì•¼ í•˜ëŠ”ì§€ì— ëŒ€í•´ì„œë„ ê³ ë¯¼í•´ì•¼ í•¨
- SqlServiceë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ëŠ” ë¹ˆì— ë“±ë¡ì´ ë  ê²ƒì´ê³ , ì–¸ì œ ì–´ë–»ê²Œ ë¹ˆ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•  ì§€ ì•Œ ìˆ˜ ì—†ìœ¼ë‹ˆ ì¼ë‹¨ ìƒì„±ìì—ì„œ SQLì„ ì¼ê±°ì™€ ë‚´ë¶€ì— ì €ì¥í•˜ëŠ” ì´ˆê¸° ì‘ì—…ì„ í•  ê²ƒì„
- ì´í›„ì— ë¦¬íŒ©í† ë§ í•˜ë©´ì„œ ì½”ë“œë¥¼ ê°œì„ í•  ê²ƒìŒ
- JAXBë¡œ XML ë¬¸ì„œë¥¼ ì–¸ë§ˆìƒ¬ë§í•˜ë©´ SQL ë¬¸ì¥ í•˜ë‚˜ëŠ” Sql í´ë˜ìŠ¤ ì˜¤ë¸Œì íŠ¸ì— í•˜ë‚˜ì”© ë‹´ê¸¸ ê²ƒì„
- Map íƒ€ì… ì˜¤ë¸Œì íŠ¸ì— ì €ì¥ í•˜ëŠ”ê²ƒì´ ì¢‹ìŒ
- UserDaoTestë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ ì„±ê³µ

```java
public class XmlSqlService implements SqlService{
    private Map<String, String> sqlMap = new HashMap<>();

    public XmlSqlService(){
        String contextPath = Sqlmap.class.getPackage().getName();

        try{
            //JAXB APIë¥¼ ì´ìš©í•´ XML ë¬¸ì„œë¥¼ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ë¡œ ì½ì–´ì˜´
            JAXBContext context = JAXBContext.newInstance(contextPath);
            Unmarshaller unmarshaller = context.createUnmarshaller();
            //UserDaoì™€ ê°™ì€ í´ë˜ìŠ¤ íŒ¨ìŠ¤ì˜ sqlmap.xml íŒŒì¼ ë³€í™˜
            InputStream is = UserDao.class.getResourceAsStream("sqlmap.xml");
            Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal(is);

            //ì½ì–´ì˜¨ SQLì„ ë§µìœ¼ë¡œ ì €ì¥
            for(SqlType sql : sqlmap.getSql())
                sqlMap.put(sql.getKey(), sql.getValue());

        } catch (JAXBException e){
            throw new RuntimeException(e);
        }
    }

    @Override
    public String getSql(String key) throws SqlRetrievalFailException {
        String sql = sqlMap.get(key);
        if(sql == null)
            throw new SqlRetrievalFailException(key+"ì— ëŒ€í•œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        else
            return sql;
    }
}
```

```java
<beans
		...
>
		<bean id="sqlService" class="com.ksb.spring.XmlSqlService">
    </bean>
</beans>
```