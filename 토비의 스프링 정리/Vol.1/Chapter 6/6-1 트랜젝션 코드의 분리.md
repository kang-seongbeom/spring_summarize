# 6.1 íŠ¸ëœì ì…˜ ì½”ë“œì˜ ë¶„ë¦¬

6.1.1 AOP(Aspect Oriented Programming)

- AOPëŠ” IoC/DI, ì„œë¹„ìŠ¤ ì¶”ìƒí™”ì™€ ë”ë¶ˆì–´ ìŠ¤í”„ë§ì˜ **3ëŒ€ ê¸°ë°˜ê¸°ìˆ **ì„
- AOPëŠ” ìŠ¤í”„ë§ì˜ ê¸°ìˆ  ì¤‘ì—ì„œ ê°€ì¥ ë‚œí•´í•œ ìš©ì–´ì™€ ê°œë…ì„ ê°€ì§„ ê¸°ìˆ ì„
- AOPëŠ” ì£¼ë¡œ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì— ë§ì´ ì‚¬ìš©ë¨
- ì„œë¹„ìŠ¤ ì¶”ìƒí™”ë¥¼ í†µí•´ ê·¼ë³¸ì  ë¬¸ì œë¥¼ í•´ê²° í–ˆì§€ë§Œ, AOPë¡œ ë”ìš± ì„¸ë ¨ë˜ê³  ê¹”ë”í•œ ë°©ì‹ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ
- AOP ë“±ì¥ ë°°ê²½, ìŠ¤í”„ë§ì´ AOPë¥¼ ë„ì…í•œ ì´ìœ , AOP ì ìš©ì˜ ì¥ì  ë“±ì„ ê³µë¶€í•  ê²ƒì„

6.1.2 ë©”ì†Œë“œ ë¶„ë¦¬

- ì„œë¹„ìŠ¤ ì¶”ìƒí™” ê¸°ë²•ì„ í†µí•´ íŠ¸ëœì­ì…˜ì˜ ê·¼ë³¸ì  ë¬¸ì œë¥¼ í•´ê²°í–ˆì§€ë§Œ UserServiceì—ëŠ” **íŠ¸ëœì­ì…˜ ë¡œì§**ê³¼ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**ì´ ê°™ì´ ì¡´ì¬í•¨
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ì¸í„°í˜ì´ìŠ¤ `PlatformTransactionManager`ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ, ë©”ì†Œë“œ ë‚´ë¶€ì— íŠ¸ëœì­ì…˜ ë¡œì§ì´ ìƒë‹¹í•œ ë¶€ë¶„ì„ ì°¨ì§€í•¨
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ **ì „í›„**ì— íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì´ ë˜ì–´ì•¼ í•˜ë¯€ë¡œ ì–´ì©”ìˆ˜ ì—†ë‹¤ê³  ëŠê»´ì§
- íŠ¸ëœì­ì…˜ ë¡œì§ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ ì‚¬ì´ì— ì£¼ê³ ë°›ëŠ” ì •ë³´ê°€ ì—†ê¸° ë•Œë¬¸ì— ë©”ì†Œë“œë¡œ ë¶„ë¦¬í•  ìˆ˜ ìˆìŒ

![https://media.vlpt.us/images/superkkj/post/4943d00b-2b20-405e-86a1-72957915b0b4/image.png](https://media.vlpt.us/images/superkkj/post/4943d00b-2b20-405e-86a1-72957915b0b4/image.png)

```java
public class UserService {
		...
		public void upgradeLevels() {
        TransactionStatus status =
                this.transactionManager.getTransaction(
                        new DefaultTransactionDefinition());
        try{
            upgradeLevelsInternal(); //ë©”ì†Œë“œ ì¶”ì¶œ
            this.transactionManager.commit(status); //ì»¤ë°‹
        }catch (Exception e){
            this.transactionManager.rollback(status); //ë¡¤ë°±
            throw e;
        }
    }

    private void upgradeLevelsInternal() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user);
            }
        }
		}
}
```

6.1.3 DIë¥¼ ì´ìš©í•œ í´ë˜ìŠ¤ì˜ ë¶„ë¦¬

- ë©”ì†Œë“œë¡œ ë¶„ë¦¬ëŠ” í–ˆì§€ë§Œ, ì—¬ì „íˆ íŠ¸ëœì­ì…˜ ë¡œì§ì´ UserService ë‚´ë¶€ì— ìˆìŒ
- íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ í´ë˜ìŠ¤ ë°–ìœ¼ë¡œ ì¶”ì¶œí•˜ë©´ ë¨
- UserServiceëŠ” í´ë˜ìŠ¤ ì´ë¯€ë¡œ, ë‹¤ë¥¸ ì½”ë“œì—ì„œ UserServiceì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ **ì§ì ‘ì **ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ë°–ì— ì—†ìŒ
    
    ![https://media.vlpt.us/images/superkkj/post/ad964c3e-d206-4b1d-9934-31f178511c45/image.png](https://media.vlpt.us/images/superkkj/post/ad964c3e-d206-4b1d-9934-31f178511c45/image.png)
    
- ì§ì ‘ ì‚¬ìš©í•˜ëŠ”ê²Œ ë¬¸ì œê°€ ë˜ë¯€ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ **ê°„ì ‘ì **ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•¨
    
    ![https://media.vlpt.us/images/superkkj/post/13fab933-104a-4623-9ac6-a9eee995bc04/image.png](https://media.vlpt.us/images/superkkj/post/13fab933-104a-4623-9ac6-a9eee995bc04/image.png)
    
- ë³´í†µ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ DIí•˜ëŠ” ì´ìœ ëŠ”, ìš´ì˜ê³¼ í…ŒìŠ¤íŠ¸ ìƒì—ì„œ ì†ì‰½ê²Œ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë°”ê¿”ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì„
- í•˜ì§€ë§Œ ê¼­ ê·¸ë˜ì•¼ í•˜ëŠ” ì œì•½ì€ ì—†ìŒ
- **ë‘ ê°œ**ì˜ UserService ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ì´ìš©í•˜ë©´. í•˜ë‚˜ì˜ êµ¬í˜„ì—ëŠ” ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ ë‚¨ê¸°ê³ , ë‹¤ë¥¸ í•˜ë‚˜ëŠ” íŠ¸ëœì­ì…˜ ë¡œì§ì˜ ì±…ì„ë§Œ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- `UserServiceTx`ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—†ê¸° ë•Œë¬¸ì— `UserServiceImpl`ì— í•´ë‹¹ ë¶€ë¶„ì„ **ìœ„ì„**í•¨
    
    ![https://media.vlpt.us/images/superkkj/post/41a05bc1-6a87-445d-8131-937b0c685704/image.png](https://media.vlpt.us/images/superkkj/post/41a05bc1-6a87-445d-8131-937b0c685704/image.png)
    

6.1.4 UserService ì¸í„°í˜ì´ìŠ¤ ë„ì…

- UserServiceë¥¼ ì¸í„°í˜ì´ìŠ¤ë¡œ ë³€ê²½í•˜ê³ , `UserServiceImpl`ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ êµ¬í˜„í•¨
- íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ `UserServiceTx`ì—ì„œ êµ¬í˜„í•˜ê³  ë¹„ì¦ˆë‹ˆìŠ¤ëŠ” ìœ„ì„í•¨
- ë¨¼ì € `UserServiceTx`ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ëœì­ì…˜ ì‘ì—…ì„ í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ **í˜¸ì¶œ(ìœ„ì„)**ë˜ì–´ì„œ ì‘ì—…ë¨

![https://media.vlpt.us/images/superkkj/post/3b27028a-6866-4844-ab16-be88cfaee2a4/image.png](https://media.vlpt.us/images/superkkj/post/3b27028a-6866-4844-ab16-be88cfaee2a4/image.png)

```java
public interface UserService {
    void add(User user);
    void upgradeLevels();
}

public class UserServiceImpl implements UserService {
		...
		public void upgradeLevels() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user);
            }
        }
    }
}

public class UserServiceTx implements UserService {

    UserService userService;
    PlatformTransactionManager transactionManager;

    public void setTransactionManager(
            PlatformTransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }

    public void setUserService(UserService userService) {
        this.userService = userService;
    }

    @Override
    public void add(User user) {
        //ìœ„ì„
        this.userService.add(user);
    }

    @Override
    public void upgradeLevels() {
        TransactionStatus status =
                this.transactionManager.getTransaction(
                        new DefaultTransactionDefinition());
        try {

            //ìœ„ì„
            this.userService.upgradeLevels();

            this.transactionManager.commit(status); //ì»¤ë°‹
        } catch (Exception e) {
            this.transactionManager.rollback(status); //ë¡¤ë°±
            throw e;
        }
    }
}
```

```xml
<beans
		.../>
		...
		<bean id="userService" class="com.ksb.spring.UserServiceTx">
        <property name="transactionManager" ref="transactionManager"/>
        <property name="userService" ref="userServiceImpl"/>
    </bean>

    <bean id="userServiceImpl" class="com.ksb.spring.UserServiceImpl">
        <property name="userDao" ref="userDao"/>
        <property name="transactionManager" ref="transactionManager" />
        <property name="mailSender" ref="mailSender"/>
    </bean>
		...
</beans>
```

6.1.5 í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜ì •

- ë‹¨ìˆœíˆ UserService ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸ í•  ë•Œ êµ¬ì²´ì  í´ë˜ìŠ¤ ì •ë³´ë¥¼ ë…¸ì¶œí•˜ëŠ”ê²ƒì´ ì¢‹ì§€ëŠ” ì•Šì§€ë§Œ, ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ ìˆ˜ë™ DIë¥¼ ì ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¼ë©´ ì–´ë–¤ í´ë˜ìŠ¤ì¸ì§€ ì•Œì•„ì•¼ í•¨
    
    <aside>
    ğŸ’¡ í…ŒìŠ¤íŠ¸ì˜ upgradeLevels() ë©”ì†Œë“œì—ì„œ ìˆ˜ë™ DIë¥¼ í•˜ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ì— userServiceImpl ë¹ˆì„ ë¶ˆì–´ì™€ì•¼ í•¨
    
    </aside>
    
- upgradeAllOrNothing()ëŠ” íŠ¸ëœì­ì…˜ ë™ì‘ í…ŒìŠ¤íŠ¸ì´ê¸° ë•Œë¬¸ì—, `UserServiceTx`ë¥¼ ìˆ˜ë™ DIì‹œì¼œ ë™ì‘í•˜ê²Œ í•¨

```java
public static class TestUserService extends UserServiceImpl {
		...
}

public class UserServiceTest {
		...
		//ìˆ˜ë™ DI ë•Œë¬¸ì— í•„ìš”í•¨
		@Autowired
    UserServiceImpl userServiceImpl;
		@Test
		public void upgradeLevels() {
				...
//        MockMailSender mockMailSender = new MockMailSender();
//        userServiceImpl.setMailSender(mockMailSender);
		}

		@Test
    public void upgradeAllOrNothing() {
        UserServiceImpl.TestUserService testUserService =
                new UserServiceImpl.TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        testUserService.setMailSender(this.mailSender);

        UserServiceTx txUserService = new UserServiceTx();
        txUserService.setTransactionManager(transactionManager);
        txUserService.setUserService(testUserService);

        userDao.deleteAll();
        for (User user : users) userDao.add(user);

        try {
            testUserService.upgradeLevels();
            fail("TestUserServiceException expected");
        } catch (UserServiceImpl.TestUserServiceException e) {
        }

        checkLevelUpgraded(users.get(1), false);
    }
}

```

6.1.6 íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì 

- ì½”ë“œë¥¼ ë¶„ë¦¬ í•¨ìœ¼ë¡œì¨ UserServiceImplëŠ” íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ê¸°ìˆ ì  ë‚´ìš©ì— ì „í˜€ ì‹ ê²½ì„ ì“°ì§€ ì•Šì•„ë„ ë¨
- ì¦‰, `UserServiceImpl`ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ êµ¬í˜„
- íŠ¸ëœì­ì…˜ì€ DIë¥¼ í†µí•´ `UserServiceTx`ë¥¼ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ í•˜ê³ , í˜¸ì¶œ(ìœ„ì„)ì„ í†µí•´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë™ì‘í•˜ê²Œ í•¨