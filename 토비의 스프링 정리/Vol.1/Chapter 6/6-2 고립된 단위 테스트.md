# 6.2 ê³ ë¦½ëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

6.2.1 ë³µì¡í•œ ì˜ì¡´ê´€ê³„ ì†ì˜ í…ŒìŠ¤íŠ¸

- ì‘ì€ ë‹¨ìœ„ë¡œ í…ŒìŠ¤íŠ¸ í•  ìˆ˜ë¡ ë…¼ë¦¬ì  ì˜¤ë¥˜ë¥¼ ì°¾ê¸° ì‰¬ì›€
- í•˜ì§€ë§Œ, ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì™€ í™˜ê²½ì— ì˜ì¡´í•˜ê³  ìˆë‹¤ë©´ ì‘ì€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì˜ ì¥ì ì„ ì–»ê¸° í˜ë“¦
- UserServiceëŠ” ì‚¬ìš©ì ê´€ë¦¬ ë¡œì§ë§Œ ê°–ëŠ” ì•„ì£¼ ë‹¨ìˆœí•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ì—ë„, **ì„¸ ê°€ì§€ì˜ ì˜ì¡´ ê´€ê³„**ë¥¼ ê°€ì§€ê³  ìˆìŒ
- UserServiceëŠ” UserDao, TransactionManager, MailSender ì˜ì¡´ì„ ê°€ì§€ê³  ìˆìŒ
- ë¬¸ì œëŠ” ì„¸ ê°€ì§€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ë“¤ì´ ìì‹ ì˜ ì½”ë“œë§Œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- Jdbcë¥¼ ì´ìš©í•´ UserDaoë¥¼ êµ¬í˜„í•œ UserDaoJdbcëŠ” DataSourceì˜ êµ¬í˜„ í´ë˜ìŠ¤, DB ë“œë¼ì´ë²„, DB ì„œë²„ê¹Œì§€ì˜ ë„¤íŠ¸ì›Œí¬ í†µì‹ , DB í…Œì´ë¸” ë“±ì— ëª¨ë‘ ì˜ì¡´í•¨
- ë”°ë¼ì„œ, UserServiceë¥¼ í…ŒìŠ¤íŠ¸ í•˜ì§€ë§Œ ê·¸ ë’¤ì˜ ì˜¤ë¸Œì íŠ¸, í™˜ê²½, ì„œë²„ìŠ¤, ì„œë²„, ë„¤íŠ¸ì›Œí¬ ë“±ë“±ì„ í•¨ê»˜ í…ŒìŠ¤íŠ¸ í•˜ëŠ” ê²ƒì„
- ì´ëŸ° í…ŒìŠ¤íŠ¸ëŠ” ì¤€ë¹„í•˜ê¸° í˜ë“¤ê³ , ëŠë¦° í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ ë° í™˜ê²½ì´ ë‹¬ë¼ì§€ë©´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë‚´ì§€ ëª»í•  ìˆ˜ ìˆìŒ

![https://incheol-jung.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MEGTVdu1oxmWfpkpPTl%2F-MEGTy_a_07RI6y-8LY_%2F6-4.png?alt=media&token=7a2ee949-ee82-4f85-925f-01d20d8d685f](https://incheol-jung.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MEGTVdu1oxmWfpkpPTl%2F-MEGTy_a_07RI6y-8LY_%2F6-4.png?alt=media&token=7a2ee949-ee82-4f85-925f-01d20d8d685f)

6.2.2 í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ UserServiceImpl ê³ ë¦½

- í…ŒìŠ¤íŠ¸ì˜ ëŒ€ìƒì€ í™˜ê²½, ì™¸ë¶€ ì„œë²„, ë‹¤ë¥¸ í´ë˜ìŠ¤ ì½”ë“œì— ì¢…ì†ë˜ê³  ì˜í–¥ë°›ì§€ ì•Šë„ë¡œ **ê³ ë¦½**í•  í•„ìš”ê°€ ìˆìŒ
- ê³ ë¦½ì„ í•˜ëŠ” ë°©ë²•ì€ **í…ŒìŠ¤íŠ¸ ëŒ€ì—­(ìŠ¤í…, ëª©)**ì„ ì‚¬ìš©í•˜ë©´ ë¨
- PlatformTransactionManagerëŠ” íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ë…ë¦½í•˜ì—¬ UserServiceImplê°€ ë” ì´ìƒ ì˜ì¡´í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë³„ë‹¤ë¥¸ ê³ ë¦½ì„ í•  í•„ìš”ê°€ ì—†ìŒ
- ë”°ë¼ì„œ UserServiceê°€ ì˜ì¡´í•˜ëŠ” ì„¸ ê°€ì§€ ì¤‘ UserDao ì™€ MailSenderë§Œ ê³ ë¦½í•˜ë©´ ë¨
- voidí˜•ì¸ upgradeLevels()ëŠ” ê²°ê³¼ë¥¼ ë°˜í™˜ ë°›ì„ ìˆ˜ ì—†ìŒ
- UserDaoëŠ” ê³ ë¦½ëœ ìƒíƒœì—ì„œ voidí˜•ì¸ upgradeLevels()ì˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ **ê²€ì¦**í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë„ë¡ ë„ì™€ì£¼ëŠ” ìŠ¤í…ì´ ì•„ë‹Œ, ê²°ê³¼ë¥¼ ê²€ì¦í•˜ëŠ” **ëª©**ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•¨
- ê¸°ì¡´ì—ëŠ” DBì— ìƒˆë¡œ ì €ì¥ëœ ê°’ì„ ê°€ì ¸ì™€ ê²€ì¦ì„ í–ˆìŒ
- ê·¸ëŸ¬ë‚˜, ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë‚˜ ì™¸ë¶€ ì„œë¸Œì—ì„œ ì˜ì¡´í•˜ì§€ ì•ŠëŠ” UserServiceImpl ê³ ë¦½ í…ŒìŠ¤íŠ¸ëŠ” ìˆ˜í–‰ ê²°ê³¼ê°€ DBì— ì €ì¥ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, ê¸°ì¡´ì˜ ë°©ë²•ìœ¼ë¡œ ì‘ì—… ê²°ê³¼ë¥¼ ê²€ì¦í•˜ê¸° í˜ë“¦
- ì´ëŸ´ë•ŒëŠ” DBì— ê²°ê³¼ê°€ ë°˜ì˜ë˜ì§€ ì•Šì§€ë§Œ, UserDaoì˜ update() ë©”ì†Œë“œë¥¼ **í˜¸ì¶œ**í•˜ëŠ” ê²ƒìœ¼ë¡œ ê²€ì¦ì„ í•˜ë©´ ë¨
- ì´ìœ ëŠ” update()ê°€ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ ë˜ì—ˆê³ , í•´ë‹¹ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ì •ìƒì ìœ¼ë¡œ ê²°ê³¼ê°€ ë°˜ì˜ë  ê²ƒì´ë¼ ì˜ˆì¸¡í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì„

![https://incheol-jung.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MEGTVdu1oxmWfpkpPTl%2F-MEGU-d53MenWVoJE1ij%2F6-5.png?alt=media&token=fcaa0093-9227-456b-9571-63f84356df3c](https://incheol-jung.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MEGTVdu1oxmWfpkpPTl%2F-MEGU-d53MenWVoJE1ij%2F6-5.png?alt=media&token=fcaa0093-9227-456b-9571-63f84356df3c)

6.2.3 ê³ ë¦½ëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í™œìš©

- ê¸°ì¡´ì˜ upgradeLevels()ëŠ” ë‹¤ì„¯ ë‹¨ê³„ì˜ ì‘ì—…ìœ¼ë¡œ êµ¬ì„±ë¨
    1. UserDaoë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ìš© ì •ë³´ë¥¼ DBì— ë„£ìŒ. DBë¥¼ ì´ìš©í•´ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ì˜ì¡´ ëŒ€ìƒì¸ DBì— ì •ë³´ë¥¼ ë„£ì–´ì•¼ í•¨
    2. ë©”ì¼ ë°œì†¡ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ MailSender ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ DIí•¨
    3. ì‹¤ì œ ëŒ€ìƒì¸ userServiceì˜ ë©”ì†Œë“œ ì‹¤í–‰
    4. ê²°ê³¼ê°€ DBì— ë°˜ì˜ëëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ UserDaoë¥¼ ì´ìš©í•´ DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê²°ê³¼ í™•ì¸
    5. ëª» ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ UserServiceì— ì˜í•œ ë©”ì¼ ë°œì†¡ì´ ìˆì—ˆëŠ”ì§€ í™•ì¸
- ì²« ë²ˆì§¸ ì‘ì—…ì€ ì˜ì¡´ê´€ê³„ë¥¼ ë”°ë¼ ë§ˆì§€ë§‰ì— ë“±ì‘í•˜ëŠ” DBë¥¼ ì¤€ë¹„
- ë‘ ë²ˆì§¸ ì‘ì—…ì€ í…ŒìŠ¤íŠ¸ë¥¼ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì™€ ì„œë²„ ë“±ì—ì„œ ê³ ë¦½í•˜ëŠ” ëª© ì˜¤ë¸Œì íŠ¸ ì¤€ë¹„
- ì„¸ ë²ˆì§¸ëŠ” ë©”ì†Œë“œ ì‹¤í–‰
- ë„¤ ë²ˆì§¸ì™€ ë‹¤ì„¯ ë²ˆì§¸ëŠ” ì½”ë“œ ì‹¤í–‰í›„ ê²°ê³¼ í™•ì¸

```java
//ì£¼ì„ìœ¼ë¡œ ì„¤ëª…
public class UserServiceTest {
		@Test
    @DirtiesContext
    public void upgradeLevels() {
        //DB í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„
        userDao.deleteAll();
        for (User user : users) userDao.add(user);

        //ë©”ì¼ë°©ì†¡ ì—¬ë¶€ í™•ì¸ì„ ìœ„í•œ ëª© ì˜¤ë¸Œì íŠ¸ DI
        MockMailSender mockMailSender = new MockMailSender();
        userServiceImpl.setMailSender(mockMailSender);

        //í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì‹¤í–‰
        userService.upgradeLevels();

        //DBì— ì €ì¥ëœ ê²°ê³¼ í™•ì¸
        checkLevelUpgraded(users.get(0), false);
        checkLevelUpgraded(users.get(1), true);
        checkLevelUpgraded(users.get(2), false);
        checkLevelUpgraded(users.get(3), true);
        checkLevelUpgraded(users.get(4), false);

        //ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ì´ìš©í•œ ê²°ê³¼ í™•ì¸
        List<String> request = mockMailSender.getRequests();
        assertThat(request.size(), is(2));
//        assertThat(request.get(0), is(users.get(1).getEmail()));
//        assertThat(request.get(0), is(users.get(1).getEmail()));
    }
		...
}
```

6.2.4 UserDao ëª© ì˜¤ë¸Œì íŠ¸

- ëª© ì˜¤ë¸Œì íŠ¸ëŠ” ìŠ¤í…ê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì„ í†µí•´ ì‚¬ìš©ë  í•„ìš”í•œ ê¸°ëŠ¥ì„ ì§€ì›í•´ì•¼ í•¨
- ê³ ë¦½í•˜ê¸° ìœ„í•´ UserDaoì™€ ì–´ë–¤ ì •ë³´ë¥¼ ì£¼ê³  ë°›ëŠ”ì§€ ì•Œì•„ì•¼ í•¨
- upgradeLevels()ì—ì„œ userDaoë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ëŠ” ë‘ ê°€ì§€ì„
    
    ```java
    public class UserServiceImpl implements UserService {
    		...
    		public void upgradeLevels() {
            List<User> users = userDao.getAll(); //ì²« ë²ˆì§¸
            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
        }
    		protected void upgradeLevel(User user) {
            user.upgradeLevel();
            userDao.update(user); //ë‘ ë²ˆì§¸
            sendUpdateEmail(user);
        }
    
    }
    ```
    
- getAll()ì€ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ í›„ë³´ ì‚¬ìš©ìì˜ ëª©ë¡ì´ë¯€ë¡œ, DBì—ì„œ ì½ì–´ì˜¨ ê²ƒì²˜ëŸ¼ ë¯¸ë¦¬ ì¤€ë¹„ëœ ì‚¬ìš©ì ëª©ë¡ì„ ì œê³µë§Œ í•˜ë©´ ë¨
- update()ëŠ” í˜¸ì¶œì˜ ë¦¬í„´ê°’ì´ ì—†ì–´ íŠ¹ë³„íˆ ì¤€ë¹„í•  ê²ƒì´ ì—†ì–´ ë¹ˆ ë©”ì†Œë“œë¡œ ë§Œë“¤ë©´ ë¨
- í•˜ì§€ë§Œ, update()ëŠ” upgradeLevels()ì˜ í•µì‹¬ ë¡œì§ì¸ **ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ** í•µì‹¬ ë¡œì§ì´ë¯€ë¡œ **ë³€ê²½**ì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì„ **ê²€ì¦**í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•¨
- update()ëŠ” ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ ëœ ë©”ì†Œë“œ ì´ë¯€ë¡œ, ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ëŠ” ê²ƒìœ¼ë¡œ ê²€ì¦í•  ìˆ˜ ìˆìŒ
- ì¦‰ getAll()ì€ í…ŒìŠ¤íŠ¸ ìŠ¤í…, update()ëŠ” ëª© ì˜¤ë¸Œì íŠ¸ë¡œì„œì˜ **í…ŒìŠ¤íŠ¸ ëŒ€ì—­**ì´ í•„ìš”
- í´ë˜ìŠ¤ ì´ë¦„ì„ `MockUserDao`ë¡œ í•˜ê³ , UserServiceì—ì„œ ìŠ¤íƒœí‹± í´ë˜ìŠ¤ë¡œ ìƒì„±
- `MockUserDao`ëŠ” UserDao êµ¬í˜„ í´ë˜ìŠ¤(UserDaoJdbc)ë¥¼ ëŒ€ì²´ í•´ì•¼ í•˜ë¯€ë¡œ UserDaoë¥¼ êµ¬í˜„
- ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë©”ì†Œë“œëŠ” `UnsupportedOperationException`ë¥¼ ë˜ì§
- ìš´ì˜ í™˜ê²½ì—ì„œ getAll() ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ë©´ DBì—ì„œ ê°€ì ¸ì˜¨ê²ƒì„ ëŒë ¤ì¤˜ì•¼ í•˜ì§€ë§Œ, ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ **ë©”ëª¨ë¦¬**ì— ì €ì¥ëœ ê°’ì„ ë˜ëŒë ¤ ì£¼ë©´ ë¨
- ëª©ì˜ getUpdated()ëŠ” **ê²€ì¦**ì„ ìœ„í•´ ì €ì¥ëœ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜

```java
public class UserServiceImpl implements UserService {
		public static class MockUserDao implements UserDao {
				//ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ í›„ë³´ User ì˜¤ë¸Œì íŠ¸ ëª©ë¡
				private List<User> users; 
				//ì—…ê·¸ë ˆì´ë“œ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ë¥¼ ì €ì¥í•´ë‘˜ ëª©ë¡
        private List<User> updated = new ArrayList<>();

        private MockUserDao(List<User> users) {
            this.users = users;
        }

        public List<User> getUpdated() {
            return this.updated;
        }

        @Override
        public List<User> getAll() {
            return this.users;
        }

        @Override
        public void update(User user) {
            updated.add(user);
        }

        @Override
        public void add(User user) {throw new UnsupportedOperationException();}

        @Override
        public User get(String id) {throw new UnsupportedOperationException();}

        @Override
        public void deleteAll() {throw new UnsupportedOperationException();}

        @Override
        public int getCount() {throw new UnsupportedOperationException();}

    }

}
```

6.2.5 MockUserDaoë¥¼ ì‚¬ìš©í–ì„œ ë§Œë“  ê³ ë¦½ í…ŒìŠ¤íŠ¸

- ê³ ë¦½ í…ŒìŠ¤ë¥¼ ë§Œë“¤ê¸° ì „ì˜ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì€ UserService íƒ€ì…ì˜ ë¹ˆì´ì—ˆìŒ
- DIë¥¼ í†µí•´ ë§ì€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì™€ ì„œë¹„ìŠ¤ ë° ì™¸ë¶€ í™˜ê²½ì— ì˜ì¡´í•˜ê³  ìˆìŒ
- í…ŒìŠ¤íŠ¸ì˜ upgradeLevels()ë¥¼ ì™„ì „íˆ ê³ ë¦½ëœ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ë©´ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ë¹ˆì„ ê°€ì ¸ì˜¬ í•„ìš”ê°€ ì—†ì–´ì¡ŒìŒ
- ë˜í•œ, DBë¥¼ ì˜ì¡´í•˜ì§€ ì•Šê²Œ ë˜ë©´ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì‚­ì œ í•˜ëŠ” deleteAll() ë° ë“±ë¡ì„ í•˜ëŠ” add()ê°€ í•„ìš”ê°€ ì—†ì–´ ë²ˆê±°ë¡œìš´ ì‘ì—…ì„ í•˜ì§€ ì•Šì•„ë„ ë¨
- ê³ ë¦½ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ MockUserDaoëŠ” ìˆ˜ì •ì ë©”ì†Œë“œë¥¼ í†µí•´ ìˆ˜ë™ DIë¥¼ í•˜ë©´ ë¨
- ëª©ì˜ update()ëŠ” ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì— ë§ëŠ” ê²½ìš°ì—ë§Œ í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì— ë‘ ë²ˆ í˜¸ì¶œ ë¨
- í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ ì‹œê°„ì´ ë§¤ìš° ë¹¨ë¼ ì¡ŒìŒ
    
    <aside>
    ğŸ’¡ ì±…ì—ì„œ 500ë°° ì´ìƒì˜ ìˆ˜í–‰ ì†ë„ ì°¨ì´ë¥¼ ë³´ì´ê³  ìˆìŒ
    
    </aside>
    

```java
public class UserServiceTest {
		...
		@Test
    public void upgradeLevels() {
        UserServiceImpl userServiceImpl = new UserServiceImpl();

        UserServiceImpl.MockUserDao mockUserDao =
                new UserServiceImpl.MockUserDao(this.users);
        userServiceImpl.setUserDao(mockUserDao);

        MockMailSender mockMailSender = new MockMailSender();
        userServiceImpl.setMailSender(mockMailSender);

        userServiceImpl.upgradeLevels();

        List<User> updated = mockUserDao.getUpdated();
        assertThat(updated.size(), is(2));
        checkUserAndLevel(updated.get(0), "k2", Level.SILVER);
        checkUserAndLevel(updated.get(1), "k4", Level.GOLD);

        List<String> request = mockMailSender.getRequests();
        assertThat(request.size(), is(2));
//        assertThat(request.get(0), is(users.get(1).getEmail()));
//        assertThat(request.get(0), is(users.get(1).getEmail()));
    }
		private void checkUserAndLevel(User updated, String expectedId,
                                   Level expectedLevel) {
        assertThat(updated.getId(), is(expectedId));
        assertThat(updated.getLevel(), is(expectedLevel));
    }
}
```

<aside>
ğŸ’¡ ê³ ë¦½ëœ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œ ëª© ì˜¤ë¸Œì íŠ¸ ì‘ì„±ê³¼ ê°™ì€ ìˆ˜ê³ ë¥¼ í•´ì•¼ í•˜ì§€ë§Œ, ì˜ì¡´ ì˜í–¥ì„ ë°›ì§€ ì•Šê³  ìˆ˜í–‰ ì‹œê°„ì´ ë§¤ìš° ë¹¨ë¼ ê·¸ ë³´ìƒì€ ì¶©ë¶„í•¨

</aside>

6.2.6 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸

- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì˜ ë‹¨ìœ„ëŠ” ì •í•˜ê¸° ë‚˜ë¦„ì„
- ì•ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ í´ë˜ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì„ ì´ìš©í•´ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë‚˜ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ê³ ë¦½í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**ë¼ í•˜ê² ìŒ
- ë‘ê°œ ì´ìƒì˜, ì„±ê²©ì´ë‚˜ ê³„ì¸µì´ ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ê°€ ì—°ë™ ë˜ê±°ë‚˜ ì™¸ë¶€ ìì›ì´ ì°¸ì—¬í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ **í†µí•© í…ŒìŠ¤íŠ¸**ë¼ í•˜ê² ìŒ
- ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìŠ¤í”„ë§ ì„¤ì • ìì²´ë„ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ê¸° ë•Œë¬¸ì— í†µí•© í…ŒìŠ¤íŠ¸ì„
- ê°€ì´ë“œ ë¼ì¸
    - í•­ìƒ ë‹¨ìœ„ í…ŒìŠ¤ë¥¼ ë¨¼ì € ê³ ë ¤
    - ìµœëŒ€í•œ ì˜ì¡´ ê´€ê³„ë¥¼ ì°¨ë‹¨í•˜ê³  í•„ìš”ì— ë”°ë¼ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì„ ì´ìš©í•˜ë„ë¡ í•¨
    - ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ë° ì—¬ëŸ¬ ì˜ì¡´ ê´€ê³„ë¥¼ ì§€ë‹ ë•Œ í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì‘ì„±
    - DAOì™€ ê°™ì´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ë§Œë“¤ê¸° í˜ë“  í…ŒìŠ¤íŠ¸ëŠ” í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì‘ì„±. ì™¸ë¶€ DBì— ì‹¤ì œ ì—°ë™ë˜ì•¼ í…ŒìŠ¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì„

6.2.7 ëª© í”„ë ˆì„ì›Œí¬

- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ìŠ¤í…ì´ë‚˜ ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í•„ìˆ˜ì ì„
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ëŠ” ë§ì€ ì¥ì •ì´ ìˆì§€ë§Œ, ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“œëŠ” ì¼ì´ ê°€ì¥ ë²ˆê±°ë¡œì›€
- MockUserDao ì²˜ëŸ¼ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì¸í„°í˜ì´ìŠ¤ ëª¨ë‘ êµ¬í˜„ì„ í•´ì•¼í•¨
- íŠ¹íˆ í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œë³„ë¡œ ë‹¤ë¥¸ ê²€ì¦ ê¸°ëŠ¥ì´ í•„ìš”í•˜ë©´ ê°™ì€ ì˜ì¡´ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜•í•œ ì—¬ëŸ¬ ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ì„ ì–¸í•´ì•¼ í•¨
- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ Mockito í”„ë ˆì„ì›Œí¬ê°€ ìˆìŒ

6.2.8 Mockito í”„ë ˆì„ì›Œí¬

- Mockito í”„ë ˆì„ì›Œí¬ëŠ” ì‚¬ìš©í•˜ê¸°ë„ í¸ë¦¬í•˜ê³ , ì½”ë“œë„ ì§ê´€ì ì„
- ê°„ë‹¨í•œ **ë©”ì†Œë“œ í˜¸ì¶œ**ë§Œìœ¼ë¡œ ë‹¤ì´ë‚´ë¯¹í•˜ê²Œ íŠ¹ì • ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í…ŒìŠ¤íŠ¸ìš© ëª© ì˜¤ë¸Œì íŠ¸ ìƒì„± ê°€ëŠ¥
- ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œëŠ” mock()ì„
- mock() ë©”ì†Œë“œëŠ”`org.mockito.Mockito` í´ë˜ìŠ¤ì— ì •ì˜ëœ **ìŠ¤íƒœí‹± ë©”ì†Œë“œ**ì„
- ìŠ¤íƒœí‹± ì„í¬íŠ¸ë¥¼ ì‚¬ìš©í•´ ë¡œì»¬ ë©”ì†Œë“œì²˜ëŸ¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŒ
- mock()ì„ ì´ìš©í•œ ëª© ì˜¤ë¸Œì íŠ¸ëŠ” ì•„ë¬´ëŸ° ê¸°ëŠ¥ì´ ì—†ìŒ. getAll() ì²˜ëŸ¼ ì‚¬ìš©ì ëª©ë¡ì„ ë¦¬í„´í•˜ë„ë¡ ìŠ¤í… ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í•¨
    
    ```java
    UserDao mockUserDao = mock(UserDao.class);
    ```
    
- mockUserDao.getAll)()ì´ í˜¸ì¶œëì„ ë•Œ(when), users ë¦¬ìŠ¤íŠ¸ë¥¼ ë¦¬í„´í•˜ë¼(thenReturn) ì„ ì–¸ì„
    
    ```java
    when(mockUserDao.getAll()).thenReturn(this.users);
    ```
    
- update()ëŠ” ë‘ë²ˆ í˜¸ì¶œí•˜ë©´ ë¨
    
    ```java
    verify(mockUserDao, times(2)).update(any(User.class))
    ```
    
- User íƒ€ì…ì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìœ¼ë©° update() ë©”ì†Œë“œê°€ ë‘ë²ˆ í˜¸ì¶œ(time(2))ëëŠ”ì§€ í™•ì¸(verify) ì„ ì–¸ì„
- any()ëŠ” íŒŒë¼ë¯¸í„°ì˜ ë‚´ìš©ì€ ë¬´ì‹œí•˜ê³  í˜¸ì¶œ íšŸìˆ˜ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŒ
- Mockito ì‚¬ìš© ìˆœì„œ
    1. **ì¸í„°í˜ì´ìŠ¤**ë¥¼ ì´ìš©í•´ ëª© ì˜¤ë¸Œì íŠ¸ ìƒì„±
    2. ëª© ì˜¤ë¸Œì íŠ¸ê°€ **ë¦¬í„´**í•  ê°’ì´ ìˆìœ¼ë©´ ì´ë¥¼ ì§€ì •. ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ë©´ ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë˜ì§€ê²Œ í•  ìˆ˜ ìˆìŒ
    3. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì— **DI**í•´ì„œ ëª© ì˜¤ë¸Œì íŠ¸ê°€ í…ŒìŠ¤íŠ¸ ì¤‘ì— ì‚¬ìš©ë˜ë„ë¡ í•¨
    4. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•œ í›„ ëª© ì˜¤ë¸Œì íŠ¸ì˜ íŠ¹ì„± ë©”ì†Œë“œê°€ í˜¸ì¶œ ëëŠ”ì§€, ì–´ë–¤ ê°’ì„ ê°€ì§€ê³  ëª‡ ë²ˆ í˜¸ì¶œ ëëŠ”ì§€ **ê²€ì¦**
    

6.2.9 Mockitoë¥¼ ì ìš©í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ

- UserDaoì˜ ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê³  getAll()ì´ í˜¸ì¶œë˜ë©´ ë¦¬í„´ê°’ì„ ì„¤ì •í•˜ê³  DIë¥¼ í•¨
- mock()ì„ ì‚¬ìš©í•˜ë©´ UserDao ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì„œ ëª© í´ë˜ìŠ¤ë¥¼ ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì•„ë„ ë¨
- MailSenderë„ ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì•„ë„ ë¨
- DIë¥¼ ë§ˆì¹˜ë©´ userServiceImoke ì˜¤ë¸Œì íŠ¸ëŠ” ê³ ë¦½ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•¨
- times()ëŠ” ë©”ì†Œë“œ í˜¸ì¶œ íšŸìˆ˜ë¥¼ **ê²€ì¦**í•¨
- any()ë¥¼ ì‚¬ìš©í•˜ë©´ íŒŒë¼ë¯¸í„° ë‚´ìš© ë¬´ì‹œí•œ ì±„ë¡œ í˜¸ì¶œíšŸìˆ˜ í™•ì¸ ê°€ëŠ¥
- MailSenderì˜ ê²½ìš° ArgumentCaptureë¥¼ ì‚¬ìš©í•´ ì‹¤ì œ MailSender ëª© ì˜¤ë¸Œì íŠ¸ì— ì „ë‹¬ëœ íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì ¸ì™€ ë‚´ìš©ì„ ê²€ì¦
- ArgumentCaptureëŠ” íŒŒë¼ë¯¸í„°ë¥¼ ì§ì ‘ ë¹„êµí•˜ê¸°ë³´ë‹¤ íŒŒë¼ë¯¸í„° ë‚´ë¶€ì˜ ì •ë³´ë¥¼ ê²€ì¦í•˜ëŠ”ë° ìœ ìš©í•¨

```java
public class UserServiceTest {
		...
		@Test
    public void mockUpgradeLevels(){
        UserServiceImpl userServiceImpl = new UserServiceImpl();

        //ë‹¤ì´ë‚´ë¯¹í•œ ëª© ì˜¤ë¸Œì íŠ¸ ìƒì„œì™€ ë©”ì†Œë“œì˜ ë¦¬í„´ ê°’ ì„¤ì •
        //ê·¸ë¦¬ê³  DIê¹Œì§€ ì„¸ì¤„ì´ë©´ ì¶©ë¶„í•¨
        UserDao mockUserDao = mock(UserDao.class);
        when(mockUserDao.getAll()).thenReturn(this.users);
        userServiceImpl.setUserDao(mockUserDao);

        //ë¦¬í„´ ê°’ì´ ì—†ëŠ” ë©”ì†Œë“œë¥¼ ê°€ì§„ ëª© ì˜¤ë¸Œì íŠ¸ëŠ” ë”ìš± ê°„ë‹¨í•¨
        MailSender mockMailSender = mock(MailSender.class);
        userServiceImpl.setMailSender(mockMailSender);

        userServiceImpl.upgradeLevels();

        //ëª© ì˜¤ë¸Œì íŠ¸ê°€ ì œê³µí•˜ëŠ” ê²€ì¦ ê¸°ëŠ¥ì„ í†µí•´ì„œ ì–´ë–¤ ë©”ì†Œë“œê°€ ëª‡ ë²ˆ í˜¸ì¶œ ëëŠ”ì§€,
        //íŒŒë¼ë¯¸í„°ëŠ” ë¬´ì—‡ì¸ì§€ í™•ì¸
        verify(mockUserDao,times(2)).update(any(User.class));
        verify(mockUserDao,times(2)).update(any(User.class));
        verify(mockUserDao).update(users.get(1));
        assertThat(users.get(1).getLevel(), is(Level.SILVER));
        verify(mockUserDao).update(users.get(3));
        assertThat(users.get(3).getLevel(), is(Level.GOLD));

        //ArgumentCaptorëŠ” íŒŒë¼ë¯¸í„° ë‚´ë¶€ ê°’ í™•ì¸í•  ë•Œ ì‚¬ìš©
        ArgumentCaptor<SimpleMailMessage> mailMessageArg =
                ArgumentCaptor.forClass(SimpleMailMessage.class);
        verify(mockMailSender, times(2)).send(mailMessageArg.capture());
        List<SimpleMailMessage> mailMessages = mailMessageArg.getAllValues();
//        assertThat(mailMessages.get(0), is(users.get(1).getEmail()));
//        assertThat(mailMessages.get(0), is(users.get(1).getEmail()));
    }
}
```