# 5.2 íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

5.2.1 ëª¨ ì•„ë‹ˆë©´ ë„

- ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ë„ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ì´ì „ì— ì—…ê·¸ë ˆì´ë“œ ëœ ê²ƒì€ ì´ˆê¸°í™” ë˜ëŠ”ê°€?
- ì¼ë¶€ ì‚¬ìš©ìê°€ ì°¨ë³„ì„±ì„ ëŠë¼ê¸° ë•Œë¬¸ì— ì—…ê·¸ë ˆì´ë“œ ë„ì¤‘ ì‹¤íŒ¨ ì‹œ, ì´ˆê¸°í™” í•˜ëŠ”ê²Œ ì˜³ìŒ
- ì§§ì€ ì—…ê·¸ë ˆì´ë“œ ì‹œê°„ ì¤‘ê°„ì— DB ì„œë²„ë¥¼ ë‹¤ìš´ì‹œí‚¤ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ì— ì¥ì•  ë°œìƒí•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥ í•˜ë©°, í…ŒìŠ¤íŠ¸ëŠ” ìë™í™”ë˜ì•¼ í•˜ë¯€ë¡œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ìƒí™©ì„ ì˜ë„ì ìœ¼ë¡œ ë§Œë“¤ ê²ƒì„
- ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚¬ ë•Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•ŠìŒ
- ê¸°ì¡´ì˜ UserService ë‚´ë¶€ì— UserServiceë¥¼ ìƒì†í•œ í…ŒìŠ¤íŠ¸ìš© í™•ì¥ static í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©
- í˜„ì¬ ë‘ ë²ˆì§¸ì™€ ë„¤ ë²ˆì§¸ ì‚¬ìš©ìê°€ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ë˜ë¯€ë¡œ, ë„¤ ë²ˆì§¸ ì‚¬ìš©ì ì²˜ë¦¬í•˜ëŠ” ì¤‘ì— ì˜ˆì™¸ ë°œìƒí•  ê²ƒì„
- upgradeLevel() ë©”ì†Œë“œ ì˜¤ë²„ë¼ì´ë“œë¥¼ í†µí•´ ë„¤ ë²ˆì§¸ idì—ì„œ ì˜ˆì™¸ ë°œìƒ
- checkLevelUpgrade()ë©”ì†Œë“œë¥¼ í†µí•´ ì—…ê·¸ë ˆì´ë“œê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸

```java
public class UserServiceTest {
		@Test
    public void upgradeAllOrNothing(){
        UserService testUserService = 
                new UserService.TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);

        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        try {
            testUserService.upgradeLevels();
            fail("TestUserServiceException expected");
        } catch (UserService.TestUserServiceException e){
        }

        checkLevelUpgraded(users.get(1), false);
    }
}

public class UserService {
		...
		protected void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
    }
		...
		public static class TestUserService extends UserService {
        private String id;
        public TestUserService(String id){
            this.id=id;
        }

        @Override
        protected void upgradeLevel(User user) {
            if(user.getId().equals(this.id)) throw new TestUserServiceException();
            super.upgradeLevel(user);
        }
    }

    public static class TestUserServiceException extends RuntimeException{}
}
```

<aside>
ğŸ’¡ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ì•¼ ì •ìƒì¸ ê²ƒì„. ì¦‰, ì¤‘ê°„ì— ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì—ëŸ¬ë‚˜ê¸° ì´ì „ ì—…ê·¸ë ˆì´ë“œëŠ” DBì— ìƒˆë¡œ ì €ì¥ëœë‹¤ëŠ” ëœ»ì„

</aside>

5.2.2 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì›ì¸

- **íŠ¸ëœì­ì…˜** ë¬¸ì œì„
- íŠ¸ëœì­ì…˜ì´ë€, ë”ì´ìƒ ë‚˜ëˆŒ ìˆ˜ ì—…ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„ë¡œ **ì›ìì„±**ì„ ì˜ë¯¸í•œë‹¤.
- upgradeLevels() ë©”ì†Œë“œëŠ” **ê°ê°ì˜ íŠ¸ëœì­ì…˜ ë‹¨ìœ„**ë¡œ ë™ì‘ì„ í•¨
- DB ìì²´ë¡œ ì™„ë²½í•œ íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ë©´ì„œ, **í•˜ë‚˜ì˜ SQL ëª…ë ¹**ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš° íŠ¸ëœì­ì…˜ì„ ë³´ì¥í•¨
- ë³„ë‹¤ë¥¸ ì„¤ì •ì„ í•˜ì§€ì•ŠëŠ” í•œ, íŠ¸ëœì­ì…˜ì€ SQL ì‹¤í–‰ ë‹¨ìœ„ë¡œ ë™ì‘
- ì¦‰, **ì—¬ëŸ¬ ê°œì˜ SQL**ì´ ì‚¬ìš©ë˜ëŠ” ì‘ì—…ì„ **í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜**ìœ¼ë¡œ ë¬¶ëŠ” **ê²½ê³„ì„¤ì •** ì‘ì—… í•„ìš”
- íŠ¸ëœì­ì…˜ ë¡¤ë°±ê³¼ ì»¤ë°‹
    1. **íŠ¸ëœì­ì…˜ ë¡¤ë°±**(Transaction Rollback)
        1. **í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜** ì‘ì—… ë„ì¤‘ ë¬¸ì œê°€ ë°œìƒí•  ê²½ìš° ì•ì„œ ì²˜ë¦¬í•´ì„œ ì„±ê³µí•œ SQL ì‘ì—…ë„ **ì´ˆê¸°í™”**
    2. **íŠ¸ëœì­ì…˜ ì»¤ë°‹**(Transaction Commit)
        1. **í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜** ì‘ì—…ì„ ëª¨ë‘ ì„±ê³µí–ˆì„ ë•Œ DBì— ì•Œë ¤ **ì‘ì—… í™•ì •**
    

5.2.3 JDBC íŠ¸ëœì­ì…˜ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •

- íŠ¸ëœì­ì…˜ ê²½ê³„ë€, íŠ¸ëœì­ì…˜ì´ **ì‹œì‘**ë˜ê³  **ì¢…ë£Œ**ë˜ëŠ” ìœ„ì¹˜
- JDBC íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ Connectionì„ ê°€ì ¸ì™€ ì‚¬ìš©í•˜ë‹¤ ë‹«ëŠ” ì‚¬ì´ì— ë°œìƒí•¨
- íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£ŒëŠ” Connection ì˜¤ë¸Œì íŠ¸ë¥¼ í†µí•´ ë°œìƒ
- JDBCì˜ ê¸°ë³¸ì„¤ì •ì€ DB ì‘ì—…ì„ ìˆ˜í–‰í•œ ì§í›„ ìë™ìœ¼ë¡œ ì»¤ë°‹í•¨
- ë•Œë¬¸ì—, setAutoCommit()ì„ falseë¡œ ì§€ì •í•´ì•¼ í•¨
- í•´ë‹¹ ì„¤ì •ì„ í•˜ë©´ commit() ë˜ëŠ” rollback()ì„ ë§Œë‚  ë•Œ ê¹Œì§€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì„
- commit() ë˜ëŠ” rollback()ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ëŠ” ì‘ì—…ì„ **íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •(Transaction Demarcation)**ì´ë¼ í•¨
- ì´ë ‡ê²Œ í•˜ë‚˜ì˜ DB ì»¤ë„¥ì…˜ ì•ˆì—ì„œ ë§Œë“¤ì–´ì§€ëŠ” íŠ¸ëœì­ì…˜ì„ **ë¡œì»¬ íŠ¸ëœì­ì…˜(Local Transaction)**ë¼ í•¨

![https://blog.kakaocdn.net/dn/Oqgdd/btqMkn2OwMf/m4kc1q8wkh5UFbmex52K1k/img.png](https://blog.kakaocdn.net/dn/Oqgdd/btqMkn2OwMf/m4kc1q8wkh5UFbmex52K1k/img.png)

5.2.4 UserServiceì™€ UserDaoì˜ íŠ¸ëœì­ì…˜ ë¬¸ì œ

- ì½”ë“œ ì–´ë””ì—ë„ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ì»¤ë°‹, ë¡¤ë°±í•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
- JDBCëŠ” Connection ì˜¤ë¸Œì íŠ¸ ë‹¨ìœ„ë¡œ íŠ¸ëœì­ì…˜ì´ ì´ë¤„ì§€ëŠ”ë°, JdbcTemplateë¥¼ ì‚¬ìš©í•˜ë©´ì„œ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- JdbcTemplateëŠ” í…œí”Œë¦¿ ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•  ë•Œ ë§ˆë‹¤ ìë™ìœ¼ë¡œ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ ë°–ì— ì—†ìŒ
- JDBCëŠ” Connection ì˜¤ë¸Œì íŠ¸ ë‹¨ìœ„ì´ë¯€ë¡œ, **í•˜ë‚˜ì˜ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ê³µìœ **í•˜ë©´ íŠ¸ëœì­ì…˜ì„ ë¬¶ì„ ìˆ˜ ìˆìŒ
- ë˜ëŠ”, DAO ë‚´ë¶€ì— updgradeLevels()ë¡œì§ì„ ë‹´ëŠ”ë‹¤ë©´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë™ì‘í•  ê²ƒì„
- í•˜ì§€ë§Œ, ê¸°ê» DI ì‘ì—…ìœ¼ë¡œ ë¶„ë¦¬í•œ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**ê³¼ **ë°ì´í„° ë¡œì§**ì„ ë‹¤ì‹œ ë¬¶ëŠ” ì‘ì—…ì´ ë˜ë¯€ë¡œ ë§¤ìš° ë°”ëŒì§í•˜ì§€ ì•ŠìŒ

![https://media.vlpt.us/images/devsigner9920/post/7f418c53-41b2-41bf-8211-43a4fb453749/289EBBF8-4FFD-4DB9-A219-2FA6E73C872A.png](https://media.vlpt.us/images/devsigner9920/post/7f418c53-41b2-41bf-8211-43a4fb453749/289EBBF8-4FFD-4DB9-A219-2FA6E73C872A.png)

5.2.5 ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‚´ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •

- UserServiceì™€ UserDaoë¥¼ ê·¸ëŒ€ë¡œ ë‘” ì±„ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ ê²°êµ­ íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ì„¤ì • ì‘ì—…ì„ UserServiceë¡œ ê°€ì ¸ì™€ì•¼ í•¨
- ì´ìœ ëŠ”, upgradeLevels() **ë©”ì†Œë“œì˜ ì‹œì‘ê³¼ í•¨ê»˜ íŠ¸ëœì­ì…˜ì´ ì‹œì‘**í•´ì•¼ í•˜ê³  **ë©”ì†Œë“œë¥¼ ì¢…ë£Œì™€ í•¨ê»˜ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œ**ë˜ì•¼ í•˜ë¯€ë¡œ
- ë˜í•œ, í•˜ë‚˜ì˜ Connection ì˜¤ë¸Œì íŠ¸ë¡œ íŠ¸ëœì­ì…˜ì´ ë™ì‘í•˜ë¯€ë¡œ upgradeLevels() ë‚´ë¶€ì— DB ì»¤ë„¥ì…˜ë„ ë§Œë“¤ê³  ì¢…ë£Œë¥¼ í•´ì•¼í•¨
- ì´ëŸ¬í•œ ì´ìœ ë¡œ upgradesLevels()ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë©”ì„œë“œë“¤ì— ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•´ ì¤˜ì•¼í•¨

![https://blog.kakaocdn.net/dn/mrW7G/btqBAWH6gpe/kXbDbpX1Szfz4G7Uj11kq1/img.png](https://blog.kakaocdn.net/dn/mrW7G/btqBAWH6gpe/kXbDbpX1Szfz4G7Uj11kq1/img.png)

![https://media.vlpt.us/images/superkkj/post/795e2130-d6d0-4d72-b862-f28147092ac7/image.png](https://media.vlpt.us/images/superkkj/post/795e2130-d6d0-4d72-b862-f28147092ac7/image.png)

![https://media.vlpt.us/images/superkkj/post/c0a63232-3080-45be-9a2b-3addbc8269d5/image.png](https://media.vlpt.us/images/superkkj/post/c0a63232-3080-45be-9a2b-3addbc8269d5/image.png)

5.2.6 UserService íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì˜ ë¬¸ì œì 

- **ë„¤ ê°€ì§€** ë¬¸ì œì ì´ ì¡´ì¬í•¨
    1. JdbcTemplateë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê³  , JDBC APIë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ˆê¸° ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°€ì•¼ í•¨
    2. Connection ì˜¤ë¸Œì íŠ¸ê°€ ê³„ì† ë©”ì†Œë“œì— ì „ë‹¬ë˜ì•¼ í•¨
        - UserServiceëŠ” ì‹±ê¸€í†¤ìœ¼ë¡œ ë˜ì–´ ìˆìœ¼ë‹ˆ UserServiceì˜ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ë‹¤ë¥¸ ë©”ì†Œë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
        - ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ê³µìœ í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ìŠ¤ë ˆë“œë³„ë¡œ ìƒì„¤í•˜ëŠ” ì •ë³´ë¥¼ ì €ì¥í•˜ë©´ ë®ì–´ì”Œì›Œì§€ëŠ” ê²½ìš°ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸
    3. ë” ì´ìƒ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì— ë…ë¦½ì ì¼ ìˆ˜ ì—†ìŒ
        - Connectionì´ ì „ë‹¬ë˜ë©´ JPAë‚˜ í•˜ì´ë²„ë„¤ì´íŠ¸ë¡œ êµ¬í˜„ ë°©ì‹ì„ ë³€ê²½í•˜ë ¤ê³  í•˜ë©´ Connection ëŒ€ì‹  EntityManagerë‚˜ Session ì˜¤ë¸Œì íŠ¸ë¥¼ UserDao ë©”ì†Œë“œê°€ ì „ë‹¬ë°›ë„ë¡œ í•´ì•¼ë˜ê¸° ë•Œë¬¸
    4. í…ŒìŠ¤íŠ¸ ì½”ë“œì— ì˜í–¥ì„ ë¼ì¹¨
    

5.2.7 íŠ¸ëœì­ì…˜ ë™ê¸°í™”

- ìŠ¤í”„ë§ì—ì„œ ë©‹ì§„ ë°©ë²•ì„ ì œê³µí•˜ê³  ìˆìŒ
- upgradeLevels()ë©”ì†Œë“œê°€ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì„ í•´ì•¼í•˜ëŠ” ê²ƒì€ í”¼í•  ìˆ˜ ì—†ìŒ
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” **íŠ¸ëœì­ì…˜ ë™ê¸°í™”(Transaction Synchronization)**ì„ ì‚¬ìš©í•˜ë©´ Connection ì˜¤ë¸Œì íŠ¸ê°€ ì „ë‹¬ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŒ
- íŠ¸ëœì­ì…˜ ë™ê¸°í™”ëŠ” **íŠ¹ë³„í•œ ì¥ì†Œ(TransactionSynchronization)**ì— Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ë³´ê´€í•˜ê³ , ì´í›„ í˜¸ì¶œë˜ëŠ” DAOì˜ ë©”ì†Œë“œì—ì„œ ì €ì¥ëœ Connectionì„ ê°€ì ¸ë‹¤ ì”€
- JdbcTemplateì€ ì´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë°©ì‹ì„ ì‚¬ìš©í•˜ê³  ìˆìŒ

![https://media.vlpt.us/images/devsigner9920/post/6e83a59a-78d7-4f81-ac15-a39a964bf352/E846D711-DFBC-43AB-A916-73473AED60CE.png](https://media.vlpt.us/images/devsigner9920/post/6e83a59a-78d7-4f81-ac15-a39a964bf352/E846D711-DFBC-43AB-A916-73473AED60CE.png)

5.2.8 JdbcTemplate íŠ¸ëœì­ì…˜ ë™ê¸°í™” ìˆœì„œ

1. UserServiceì—ì„œ Connection ìƒì„±
2. Connectionì„ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— ì €ì¥ ë° setAutoCommit(fasle)ë¥¼ í˜¸ì¶œ
3. ì²« ë²ˆì§¸ dao.update() ì‹¤í–‰
4. Connectionì„ ìƒì„±í•˜ê¸° ì „ì— íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— Connectionì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ ë° ê°€ì ¸ì˜´

 5. ê°€ì ¸ì˜¨ Connectionì„ ì´ìš©í•´ PrepareStatementë¥¼ ë§Œë“¤ì–´ ìˆ˜ì • SQL ì‹¤í–‰

1. Connectionì„ ë‹«ì§€ì•Šê³  3ë²ˆ ë¶€í„° ë°˜ë³µ 

... 

1. Connectionì˜ commit()ì„ í˜¸ì¶œí•´ì„œ íŠ¸ëœì­ì…˜ ì™„ë£Œì‹œí‚´
2. íŠ¸ëœì­ì…˜ ë™ê°€í™” ì €ì¥ì†Œì—ì„œ Connection ì œê±°

<aside>
ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì€ ì‘ì—… ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì¶©ëŒì´ ë°œìƒí•˜ì§€ ì•ŠìŒ

</aside>

5.2.9 íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì ìš©

- ìŠ¤í”„ë§ì€ JdbcTemplateê³¼ ë”ë¶ˆì–´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ê°„ë‹¨í•œ ìœ í‹¸ë¦¬í‹° ë©”ì†Œë“œë¥¼ ì œê³µí•˜ê³  ìˆìŒ
- UserServiceì—ì„œ DB ì»¤ë„¥ì…˜ì„ ìœ„í•´ DataSourceê°€ í•„ìš”í•˜ë¯€ë¡œ DI ì„¤ì •ì„ í•´ ì¤˜ì•¼í•¨
- ìŠ¤í”„ë§ì— ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê´€ë¦¬ í´ë˜ìŠ¤ëŠ” `TransactionSynchronizationManager`ê°€ ìˆìŒ
- í•´ë‹¹ í´ë˜ìŠ¤ì˜ *`initSynchronization()`*ë¥¼ í†µí•´ ì´ˆê¸°í™” ìš”ì²­ì„ í•¨
- `DataSourceUtils`ì—ì„œ ì œê³µí•˜ëŠ” `getConnection()`ì„ í†µí•´ DB ì»¤ë„¥ì…˜ ìƒì„± ë° íŠ¸ëœì­ì…˜ ë™ê¸°í™”ì— ì‚¬ìš©ë˜ë„ë¡ ì €ì¥ì†Œì— **ë°”ì¸ë”©**í•¨
- í•´ë‹¹ ì„¤ì •ì„ í•˜ë©´ JdbcTemplateì˜ ì‘ì—…ì—ì„œ ë™ê¸°í™” ëœ DB ì»¤ë„¥ì…˜ ì‚¬ìš©
- JdbcTemplateëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— DB ì»¤ë„¥ì…˜ì´ ì—†ì„ ê²½ìš°ì—ë§Œ ì§ì ‘ DB ì»¤ë„¥ì…˜ì„ ìƒì„±í•¨
- ë”°ë¼ì„œ DAOë¥¼ ì‚¬ìš©í•  ë•Œ íŠ¸ëœì­ì…˜ì´ êµ³ì´ í•„ìš” ì—†ë‹¤ë©´ ë°”ë¡œ í˜¸ì¶œí•˜ë©´ ë˜ê³ , DAO ì™¸ë¶€ì—ì„œ íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ê³  ê´€ë¦¬ê°€ í•„ìš”í•˜ë©´ DB ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ê³  ë™ê¸°í™”ë¥¼ í•´ ì£¼ë©´ ë¨

```java
public class UserService {
		protected DataSource dataSource;
		public void setDataSource(DataSource dataSource){
        this.dataSource = dataSource;
    }
		public void upgradeLevels() throws SQLException {
        TransactionSynchronizationManager.initSynchronization();
				//ì—¬ê¸°ì„œ dataSource í•„ìš”
        Connection c = DataSourceUtils.getConnection(dataSource);
        c.setAutoCommit(false);
        try{
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
            c.commit(); //ì»¤ë°‹
        }catch (Exception e){
            c.rollback(); //ë¡¤ë°±
            throw e;
        } finally {
						//ìŠ¤í”„ë§ ìœ íŒ…ë¦¬í‹° ë©”ì†Œë“œë¥¼ ì´ìš©í•´ DB ì»¤ë„¥ì…˜ì„ ì•ˆì „í•˜ê²Œ ë‹«ìŒ
            DataSourceUtils.releaseConnection(c, dataSource);
            TransactionSynchronizationManager.unbindResource(this.dataSource);
            TransactionSynchronizationManager.clearSynchronization();
        }
    }
		...
}
public class UserServiceTest {
		@Autowired
    DataSource dataSource;
		@Test
    public void upgradeLevels() throws SQLException {
				...
		}
		@Test
    public void upgradeAllOrNothing() throws Exception{
				UserService testUserService =
                new UserService.TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        testUserService.setDataSource(this.dataSource);
				...
		}
```

```xml
<beans
		...>
		<bean id="userService" class="com.ksb.spring.UserServiceImpl">
        <property name="userDao" ref="userDao"/>
        <property name="dataSource" ref="dataSource" />
    </bean>
		...
<beans>
```

5.2.10 ê¸°ìˆ ê³¼ í™˜ê²½ì— ì¢…ì†ë˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œ

- ìƒˆë¡œìš´ ë¬¸ì œê°€ ë°œìƒí•¨
- G íšŒì‚¬ê°€ ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë“ˆì„ êµ¬ë§¤í•´ì„œ ì‚¬ìš©í•˜ê³ ì í•˜ëŠ”ë°, í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ **ì—¬ëŸ¬ê°œ DB**ì— ë°ì´í„°ë¥¼ ë„£ëŠ” ì‘ì—…ì„ í•  ê²ƒì„
- í•˜ì§€ë§Œ, í˜„ì¬ì˜ ì½”ë“œëŠ” JDBCì˜ Connectionì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë°©ì‹ì¸ **ë¡œì»¬ íŠ¸ëœì­ì…˜** ë°©ì‹ì„
- **ë¡œì»¬ íŠ¸ëœì­ì…˜**ì€ **í•˜ë‚˜ì˜ DB Connectionì— ì¢…ì†**ë˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ê°œ DBì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ
- ë³„ë„ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ìë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” **ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜(Global Transaction)** ë°©ì‹ í•„ìš”
- ìë°”ëŠ” JDBC ì™¸ì— ê¸€ë¡œë²Œ íŠ¸ëœì ì…˜ì„ ì§€ì›í•˜ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € API ì¸ **JTA(Java Transaction API)**ë¥¼ ì œê³µí•˜ê³  ìˆìŒ
- DBëŠ” JDBC, ë©”ì‹œì§• ì„œë²„ëŠ” JMSê°™ì€ APIë¥¼ ì‚¬ìš©í•¨
- **ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜**ì„ ìœ„í•´ JDBCë‚˜ JMS APIë¥¼ ì§ì ‘ ì œì–´í•˜ì§€ ì•Šê³ , **JTA**ë¥¼ í†µí•´ **íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ê°€ ê´€ë¦¬**í•˜ë„ë¡ **ìœ„ì„**í•¨
- íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” XA í”„ë¡œí† ì½œì„ í†µí•´ ë¦¬ì†ŒìŠ¤ì™€ ì—°ê²°ë¨
- ì´ë¥¼í†µí•´ **íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €**ê°€ ì‹¤ì œ **DB**ì™€ **ë©”ì‹œì§• ì„œë²„**ì˜ íŠ¸ëœì­ì…˜ì„ **ì¢…í•©ì ìœ¼ë¡œ ì œì–´**í•  ìˆ˜ ìˆê²Œ ë¨
- ì¦‰, G íšŒì‚¬ì˜ ìš”ì²­ì€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì™€ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  í…Œë‹ˆ JDBC APIê°€ ì•„ë‹Œ JTAë¥¼ ì‚¬ìš©í•´ ê´€ë¦¬í•˜ê²Œ í•´ë‹¬ë¼ëŠ” ê²ƒì„
- JTAë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • êµ¬ì¡°ëŠ” JDBCë¥¼ ì‚¬ìš©í•  ë•Œì™€ ë¹„ìŠ·í•¨
- Connectionì˜ ë©”ì†Œë“œ ëŒ€ì‹  UserTransactionì˜ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ì°¨ì´ë§Œ ì¡´ì¬

<aside>
ğŸ’¡ ì¦‰, í•˜ë‚˜ ì´ìƒì˜ DBê°€ ì°¸ì—¬í•˜ëŠ” íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ê¸°ìœ„í•´ JTA í•„ìš”

</aside>

![https://media.vlpt.us/images/superkkj/post/349511fc-120f-4ec7-82ac-6aab9ae39f4a/image.png](https://media.vlpt.us/images/superkkj/post/349511fc-120f-4ec7-82ac-6aab9ae39f4a/image.png)

![https://media.vlpt.us/images/superkkj/post/7e82d265-742f-4895-a334-adaf8b5ff584/image.png](https://media.vlpt.us/images/superkkj/post/7e82d265-742f-4895-a334-adaf8b5ff584/image.png)

5.2.11 ê¸°ì¡´ì˜ UserServiceì˜ ë¬¸ì œ

- UserServiceì˜ `upgradeLevels()`ëŠ” JDBC ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ì´ìš©í•œ ì½”ë“œì„
- JDBC ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ JTAë¥¼ ì´ìš©í•˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´ UserServiceë¥¼ ìˆ˜ì •í•´ì•¼ í•¨
- **ë¡œì»¬ íŠ¸ëœì­ì…˜**ì„ ì‚¬ìš©ë©´ ì¶©ë¶„í•œ ê³ ê°ì€ JDBCë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì½”ë“œë¥¼, G íšŒì‚¬ ì²˜ëŸ¼ ë‹¤ì¤‘ DBë¥¼ ìœ„í•œ **ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜**ì„ í•„ìš”í•˜ëŠ” ê³³ì€ JTAë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì½”ë“œë¥¼ ì ìš©í•´ì•¼ í•¨
- ì¦‰, UserServiceëŠ” **ë¡œì§ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì—ë„ ê¸°ìˆ ì  í™˜ê²½ì— ë”°ë¼ ì½”ë“œê°€ ë³€ê²½**ë˜ì•¼ í•¨
- ë˜, Y íšŒì‚¬ì—ì„œ JDBCê°€ ì•„ë‹Œ í•˜ì´ë²„ë„¤ì´íŠ¸ë¥¼ ì‚¬ìš©í•œ UserDaoë¥¼ ì§ì ‘ êµ¬í˜„í•œë‹¤ê³  ìš”êµ¬í•¨
- ê¸°ì¡´ DI êµ¬ì¡°ë¥¼ í†µí•´ UserServiceë¥¼ ë³€ê²½í•˜ì§€ ì•Šì•„ë„ XMLì—ì„œ DBë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŒ
- í•˜ì§€ë§Œ, í•˜ì´ë²„ë„¤ì´íŠ¸ë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì½”ë“œëŠ” JDBCë‚˜ JTAì˜ ì½”ë“œì™€ ë˜ ë‹¤ë¦„
- í•˜ì´ë²„ë„¤ì´íŠ¸ì˜ ê²½ìš° Connectionì„ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , Sessionì„ ì‚¬ìš©í•¨
- ë˜í•œ, ë…ìì ì¸ íŠ¸ëœì­ì…˜ ê´€ë¦¬ API ì‚¬ìš©í•¨
- Y íšŒì‚¬ì˜ ìš”êµ¬ë¥¼ ë“¤ì–´ì£¼ê¸° ìœ„í•´ì„œëŠ” í•˜ì´ë²„ë„¤ì´íŠ¸ì˜ Sessionê³¼ Transaction ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œë¥¼ ë³€ê²½í•  ìˆ˜ ë°–ì— ì—†ìŒ.
    
    <aside>
    ğŸ’¡ ì¦‰, UserServiceëŠ” ë¡œì§ì´ ë³€ê²½ë˜ì§€ ì•Šì•„ë„ ê¸°ìˆ ì— ë”°ë¼ ë³€ê²½ë˜ëŠ” ë¬¸ì œ ë°œìƒ
    
    </aside>
    

5.2.12 íŠ¸ëœì­ì…˜ APIì˜ ì˜ì¡´ê´€ê³„ ë¬¸ì œì™€ í•´ê²°ì±…

- ê¸°ì¡´ì˜ UserServiceëŠ” ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì´ ë³€ê²½ë˜ë”ë¼ë„ UserServiceì˜ ì½”ë“œëŠ” ì˜í–¥ë°›ì§€ ì•Šì•˜ìŒ
- í•˜ì§€ë§Œ, UserServiceì—ì„œ **ê²½ê³„ì„¤ì • ì½”ë“œë¥¼ ì¶”ê°€**í•˜ë©´ì„œ íŠ¹ì • ë°ì´í„° ì•¡ì„¸ìŠ¤ **ê¸°ìˆ (JDBC)ì— ì¢…ì†ì ì¸ êµ¬ì¡°**ê°€ ë˜ì—ˆìŒ
- UserServiceëŠ” UserDaoJdbcì•  ê°„ì ‘ì  ì˜ì¡´í•˜ëŠ” ì½”ë“œê°€ ë˜ì—ˆìŒ
- ë‹¤í–‰íˆ, íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ì„¤ì • ë‹´ë‹¹í•˜ëŠ” ì½”ë“œëŠ” **ì¼ì •í•œ íŒ¨í„´**ì„ ê°€ì§€ëŠ” ìœ ì‚¬í•œ êµ¬ì¡°ì„
- ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ë‹´ë‹¹ ì½”ë“œì˜ ê³µí†µì ì„ **ì¶”ìƒí™”** í•˜ì—¬ í•˜ìœ„ ì‹œìŠ¤í…œì´ ë³€ê²½ë˜ë”ë¼ë„ ì¼ê´€ëœ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŒ

![https://media.vlpt.us/images/devsigner9920/post/b17b6904-4451-4db4-a068-b31ca2e107da/95E93271-D85D-4D9D-BBE3-26CC6273BC7E.png](https://media.vlpt.us/images/devsigner9920/post/b17b6904-4451-4db4-a068-b31ca2e107da/95E93271-D85D-4D9D-BBE3-26CC6273BC7E.png)

5.2.13 ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ ê¸°ìˆ ì˜ ê³µí†µì ì„ ë‹´ì€ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ ì„ ì œê³µí•˜ê³  ìˆìŒ
- í•´ë‹¹ ê¸°ìˆ ë¡œ ê° ê¸°ìˆ ì˜ APIë¥¼ ì´ìš©í•˜ì§€ ì•Šì•„ë„, ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì œì–´í•˜ëŠ” ê²½ê³„ì„¤ì • ì‘ì—…ì´ ê°€ëŠ¥í•¨
- ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì¶”ìƒ ì¸í„°í˜ì´ëŠ” `PlatformTransactionManager`ì„
- JDBCì˜ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ì´ìš©í•˜ë©´ `dataSource`ë¥¼ `DataSourceTransactionManager`ì˜ ìƒì„±ìì— ì „ë‹¬í•˜ì—¬ ì˜¤ë¸Œì íŠ¸ ìƒì„±
- `getTransaction()`ë§Œ í•´ì£¼ë©´ í•„ìš”ì— ë”°ë¼ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ê°€ DB ì»¤ë„¥ì…˜ì„ ê°€ì ¸ì˜¤ëŠ” ì‘ì—… ìˆ˜í–‰ ë° íŠ¸ëœì ¹ì„¼ ì‹œì‘
- `DefaultTransactionDefinition`ëŠ” íŠ¸ëœì­ì…˜ì˜ **ì†ì„±**ì„ ê°€ì§
- ì‹œì‘ëœ íŠ¸ëœì­ì…˜ì€ `TransactionStatus` íƒ€ì…ì˜ ë²¼ìˆ˜ì— ì €ì¥ë¨
- `TransactionStatus`ëŠ” ì¡°ì‘ì´ í•„ìš”í•  ë•Œ **ë©”ì†Œë“œì˜ íŒŒë¼ë¯¸í„°**ë¡œ ì „ë‹¬í•˜ë©´ ë¨

![https://media.vlpt.us/images/devsigner9920/post/455569ff-fe9c-4608-8543-d41cf4d96933/90560972-F222-4B34-891D-E27440A186BB.png](https://media.vlpt.us/images/devsigner9920/post/455569ff-fe9c-4608-8543-d41cf4d96933/90560972-F222-4B34-891D-E27440A186BB.png)

```java
public class UserService {
		...
		public void upgradeLevels() {
        PlatformTransactionManager transactionManager =
                new DataSourceTransactionManager(dataSource);
        TransactionStatus status =
                transactionManager.getTransaction(
                        new DefaultTransactionDefinition());
        try{
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
            transactionManager.commit(status); //ì»¤ë°‹
        }catch (Exception e){
            transactionManager.rollback(status); //ë¡¤ë°±
            throw e;
        }
    }
		...
}
```

5.2.14 íŠ¸ëœì­ì…˜ ê¸°ìˆ  ì„¤ì •ì˜ ë¶„ë¦¬

- íŠ¸ëœì­ì…˜ ì¶”ìƒí™” APIë¥¼ ì ìš©í•œ UserService ì½”ë“œë¥¼ JTAë¥¼ ì´ìš©í•˜ëŠ” **ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜**ìœ¼ë¡œ ë³€ê²½
- `DataSourceTransactionManager`ë¥¼ `JTATransactionManager`ë¡œ ë³€ê²½í•˜ë©´ ë¨
    
    ```java
    PlatformTransactionManager txManager = new JTATransactionManager();
    ```
    
- ëŠ” ì£¼ìš” ìë°” ì„œë²„ì—ì„œ ì œê³µí•˜ëŠ” JTA ì •ë³´ë¥¼ JNDIë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ëŠ” ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆìŒ
- `JTATransactionManager`ë§Œ ì‚¬ìš©í•´ë„ ì„œë²„ì˜ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €/ì„œë¹„ìŠ¤ì™€ ì—°ë™í•´ì„œ ë™ì‘ë¨
- í•˜ì§€ë§Œ, ì–´ë–¤ **íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € êµ¬í˜„ í´ë˜ìŠ¤**ë¥¼ ì‚¬ìš©í• ì§€ UserServiceê°€ ì•Œê³  ìˆëŠ” ê²ƒì€ **DI ì›ì¹™ì— ìœ„ë°°**ë¨
- ì»¨í…Œì´ë„ˆë¥¼ í†µí•´ DI ë°›ë„ë¡ í•´ì•¼í•¨
- ëª¨ë“  `PlatformTransactionManager` **êµ¬í˜„ í´ë˜ìŠ¤**ëŠ” ì‹±ê¸€í†¤ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ë„ ë¨
- ì¼ë°˜ì ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„, ë³€ìˆ˜ ì´ë¦„, ìˆ˜ì •ì ë©”ì†Œë“œ ì´ë¦„ì€ ëª¨ë‘ ê°™ë„ë¡ í†µì¼í•˜ì§€ë§Œ, `PlatformTransactionManager`ëŠ” ê´€ë¡€ì ìœ¼ë¡œ **transactionManger**ë¼ëŠ” ì´ë¦„ ì‚¬ìš©
- UserServiceì— ì¶”ê°€í•œ DataSourceëŠ” ë”ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±° ë° **transactionManger** ì¶”ê°€
- JDBCë¥¼ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— XMLì— `PlatformTransactionManager`êµ¬í˜„ í´ë˜ìŠ¤ì¸ `DataSourceTransactionManager`ë¡œ ì„¤ì •
- JTAë¥¼ ì´ìš©í•˜ë ¤ë©´ `JtaTransactionManger`ë¡œ ì„¤ì •

```java
public class UserService {
		private PlatformTransactionManager transactionManager;
		...

		public void setTransactionManager(PlatformTransactionManager
                                      transactionManager){
        this.transactionManager = transactionManager;
    }
		public void upgradeLevels() {
        TransactionStatus status =
                this.transactionManager.getTransaction(
                        new DefaultTransactionDefinition());
        try{
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user);
                }
            }
            this.transactionManager.commit(status); //ì»¤ë°‹
        }catch (Exception e){
            this.transactionManager.rollback(status); //ë¡¤ë°±
            throw e;
        }
    }
}

public class UserServiceTest {
		@Autowired
    PlatformTransactionManager transactionManager;
		...
		@Test
    public void upgradeAllOrNothing() {
        UserService testUserService =
                new UserService.TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        testUserService.setTransactionManager(this.transactionManager);

        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        try {
            testUserService.upgradeLevels();
            fail("TestUserServiceException expected");
        } catch (UserService.TestUserServiceException e){
        }

        checkLevelUpgraded(users.get(1), false);
    }
}
```

```xml
<beans
		...>
		<bean id="userService" class="com.ksb.spring.UserServiceImpl">
        <property name="userDao" ref="userDao"/>
        <property name="transactionManager" ref="transactionManager" />
    </bean>

		<bean id ="transactionManager" 
          class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
		...
</beans>
```