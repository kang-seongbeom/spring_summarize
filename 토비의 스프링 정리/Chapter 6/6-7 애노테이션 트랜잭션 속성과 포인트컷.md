# 6.7 μ• λ…Έν…μ΄μ… νΈλμ­μ… μ†μ„±κ³Ό ν¬μΈνΈμ»·

6.7.1 νΈλμ­μ… μ• λ…Έν…μ΄μ…

- **ν¬μΈνΈμ»·**κ³Ό **νΈλμ­μ… μ†μ„±**μ„ μ΄μ©ν•΄ νΈλμ­μ…μ„ μΌκ΄„μ μΌλ΅ μ μ©ν•λ” λ°©μ‹μ€ λ€λ¶€λ¶„ μƒν™©μ—μ„ μ λ“¤μ–΄λ§μ
- ν•μ§€λ§, μ„Έλ°€ν•κ² νλ‹λ νΈλμ­μ… μ†μ„±μ κ²½μ° ν¬μΈνΈμ»·κ³Ό νΈλμ­μ… μ†μ„± μ‚¬μ©μΌλ΅λ” μ ν•©ν•μ§€ μ•μ
- ν¬μΈνΈμ»·κ³Ό νΈλμ­μ… μ†μ„±κ³Ό κ°™μ΄ μ„¤μ • νμΌμ—μ„ λ¶„λ¥ κ°€λ¥ν• κ·Έλ£ΉμΌλ΅ λ§λ“¤μ–΄ μΌκ΄„μ μΌλ΅ μ†μ„±μ„ λ¶€μ—¬ν•λ” λ€μ‹ ,  μ§μ ‘ νƒ€ν‚·μ— μ†μ„±μ •λ³΄λ¥Ό κ°€μ§„ μ• λ…Έν…μ΄μ…μ„ μ§€μ •ν•΄ μ„Έλ°€ν•κ² νΈλμ­μ… μ†μ„±μ„ μ μ©ν•¨
- μ΄ μ• λ…Έν…μ΄μ…μ„ **νΈλμ­μ… μ• λ…Έν…μ΄μ…**μ΄λΌ ν•¨
- **@Transaction** μ• λ…Έν…μ΄μ…μ„ μ •μν• μ½”λ“
    
    ```java
    @Target({ElementType.METHOD, ElementType.TYPE})
    @Retention(RetentionPolicy.RUNTIME)
    @Inherited
    @Documented
    public @interface Transactional {
      @AliasFor("transactionManager")
    	String value() default "";
    	@AliasFor("value")
    	String transactionManager() default "";
    	Propagation propagation() default Propagation.REQUIRED;
    	Isolation isolation() default Isolation.DEFAULT;
    	int timeout() default TransactionDefinition.TIMEOUT_DEFAULT;
    	boolean readOnly() default false;
    	Class<? extends Throwable>[] rollbackFor() default {};
    	String[] rollbackForClassName() default {};
    	Class<? extends Throwable>[] noRollbackFor() default {};
    	String[] noRollbackForClassName() default {};
    }
    ```
    
- @Transaction νƒ€κΉƒμ€ **λ©”μ†λ“**μ™€ **νƒ€μ…**μ„
- λ”°λΌμ„ λ©”μ†λ“, ν΄λμ¤, μΈν„°νμ΄μ¤μ— μ‚¬μ©ν•  μ μμ
- @Transactionμ΄ λ¶€μ—¬λ λ¨λ“  μ¤λΈμ νΈλ¥Ό μλ™ **νƒ€κΉƒ μ¤λΈμ νΈ**λ΅ μΈμ‹ν•¨
- μ΄λ•, μ‚¬μ©λλ” ν¬μΈνΈμ»·μ€ `TransactionAttributeSourcePointcut`μ„
- `TransactionAttributeSourcePointcut`μ€ μ¤μ¤λ΅ ν‘ν„μ‹κ³Ό κ°™μ€ μ„ μ • κΈ°μ¤€μ„ κ°–μ§€ μ•μ
- λ€μ‹ , @Transactionμ΄ λ¶€μ—¬λ λ©”μ†λ“ λ° μ¤λΈμ νΈλ¥Ό λ¨λ‘ μ°Ύμ•„ ν¬μΈνΈμ»· μ„ μ • κ²°κ³Όλ΅ λλ ¤μ¤
- μ¦‰, ν¬μΈνΈμ»·μ„ ν†µκ³Όμ‹μΌ νΈλμ­μ… μ†μ„±μ„ μ΄μ©ν•΄ μ„ μ • λ©”μ†λ“ λ° νƒ€μ…μ„ ν•„ν„°λ§ν•¨
- @Transaction μ—λ¦¬λ¨ΌνΈλ΅ νΈλμ­μ… μ†μ„±μ„ λ¶€μ—¬ν•¨
- μμ‹
    
    ```java
    @Transactional(readOnly=ture)
    ```
    

6.7.2 νΈλμ­μ… μ†μ„±μ„ μ΄μ©ν•λ” ν¬μΈνΈμ»·

- `TransactionInterceptor`λ” λ©”μ†λ“ μ΄λ¦„ ν¨ν„΄μ„ ν†µν•΄ λ¶€μ—¬λλ” μΌκ΄„μ μΈ νΈλμ­μ… μ†μ„±μ •λ³΄ λ€μ‹  @Transaction μ—λ¦¬λ¨ΌνΈμ—μ„ νΈλμ­μ… μ†μ„±μ„ κ°€μ Έμ¤λ” `AnnotationTransactionAttributeSource`λ¥Ό μ‚¬μ©ν•¨
- @Transactionμ€ λ©”μ†λ“ λ° νƒ€μ…λ§λ‹¤ λ‹¤λ¥΄κ² μ„¤μ •ν•  μ μμ–΄ λ§¤μ° μ μ—°ν• νΈλμ­μ… μ†μ„± μ„¤μ •μ΄ κ°€λ¥ν•¨
- @Transaction λ°©μ‹μ„ μ‚¬μ©ν•λ©΄ **ν¬μΈνΈμ»·**κ³Ό **νΈλμ­μ… μ†μ„±**μ„ μ• λ…Έν…μ΄μ… ν•λ‚λ΅ μ§€μ •ν•  μ μμ
- λ‹¨ λ©”μ†λ“λ§λ‹¤ @Transactionμ„ λ„£μ–΄ μ μ—°ν• μ†μ„± μ μ–΄λ” κ°€λ¥ν•κ² μ§€λ§, μ½”λ“κ°€ μ§€μ €λ¶„ν•΄μ§€κ³  λ™μΌν• μ†μ„± μ •λ³΄λ¥Ό κ°€μ§„ μ• λ…Έν…μ΄μ…μ„ λ°λ³µμ μΌλ΅ μ‚¬μ©ν•  μ λ°–μ— μ—†μ

![https://gunju-ko.github.io//assets/img/posts/toby-spring/transaction/%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-2.png](https://gunju-ko.github.io//assets/img/posts/toby-spring/transaction/%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-2.png)

6.7.3 λ€μ²΄ μ •μ±…

- @Transactionalμ„ μ μ©ν•  λ• 4λ‹¨κ³„μ λ€μ²΄(Fallback)μ •μ±…μ„ μ‚¬μ©ν•μ—¬ λ°λ³µμ μΈ μ• λ…Έν…μ΄μ… μ‚¬μ©μ„ λ§‰κΈ°μ„ μ μμ
- @Transaction μ• λ…Έν…μ΄μ…μ„ μ°Ύμ„ λ• **μμ„**κ°€ μμ
    1. νƒ€κΉƒ λ©”μ†λ“ 
    2. νƒ€κΉƒ ν΄λμ¤ 
    3. μ„ μ–Έ λ©”μ†λ“ 
    4. μ„ μ–Έ νƒ€μ…
    
    <aside>
    π’΅ [νƒ€κΉƒ = ν•μ„ ν΄λμ¤], [μ„ μ–Έ = μνΌ ν΄λμ¤ or μΈν„°νμ΄μ¤]λΌ μƒκ°ν•λ©΄ νΈν•¨
    
    </aside>
    

```java
[1]
public interface Service { 
	[2]
	void method1(); 
	[3]
	void method2();
}

[4]
public class Servicelmpl implements Service {
	[5]
	public void method1() (
	[6]
	public void method2() {
}
```

- @Transaction μ• λ…Έν…μ΄μ…μ„ μ°Ύλ” **μμ„**μ— λ”°λΌ, **νƒ€κΉƒ λ©”μ†λ“**μΈ [5]μ™€ [6]μ΄ @Transactionμ΄ μ¬ μ μλ” μ²« λ²μ§Έ ν›„λ³΄μ„. λ‘ λ²μ§Έλ” **νƒ€κΉƒ ν΄λμ¤**μΈ [4]μ„. μ„Έ λ²μ§Έλ” **μ„ μ–Έ λ©”μ†λ“**μΈ [2]μ™€ [3]μ„. λ„¤ λ²μ§Έλ” **μ„ μ–Έ νƒ€μ…**μΈ [1]μ„
- νƒ€κΉƒ ν΄λμ¤λ‚, μ„ μ–Έ νƒ€μ…μ—λ§ @Transactionalμ„ λ„£μΌλ©΄ ν•΄λ‹Ή ν΄λμ¤ λ° νƒ€μ…μ— μλ” λ©”μ†λ“λ” κ³µν†µμ μΌλ΅ ν΄λμ¤ λ° μ„ μ–Έ λ λ²¨μ— μλ” @Transaction μ—λ¦¬λ¨ΌνΈλ¥Ό **κ³µμ **ν•¨
- μΈν„°νμ΄μ¤μ— @Transactionμ„ λ‘λ©΄ κµ¬ν„ ν΄λμ¤κ°€ λ°”λ€λ”λΌλ„ νΈλμ­μ… μ†μ„±μ„ μ μ§€ν•  μ μλ‹¤λ” μ¥μ μ΄ μμ
- ν•μ§€λ§, ν”„λ΅μ‹ λ°©μ‹μ΄ μ•„λ‹ νΈλμ­μ…μ„ μ μ©ν•λ©΄ μΈν„°νμ΄μ¤μ @Transactionμ€ λ¬΄μ‹λκΈ° λ•λ¬Έμ—, νƒ€κΉƒ ν΄λμ¤μ— @Transactionμ„ λ„£λ” λ°©μ‹μ„ **κ¶μ¥**ν•¨

6.7.4 νΈλμ­μ… μ• λ…Έν…μ΄μ… μ μ©

- μ¤ν”„λ§μ€ @Transactionalμ„ μ΄μ©ν• νΈλμ­μ… μ†μ„±μ„ μ‚¬μ©ν•λ”λ° ν•„μ”ν• μ„¤μ •μ„ νƒκ·Έ ν•λ‚μ— λ‹΄μ•„λ’€μ
    
    ```xml
    <beans
    		...>
    		<tx:annotaion-driven>
    </beans>
    ```
    

6.7.5 UserServiceμ— @Transactional μ μ©

- κΌ­ μ„Έλ°€ν• νΈλμ­μ… μ„¤μ •μ΄ ν•„μ”ν•  λ•λ§ @Transactionalμ„ μ‚¬μ©ν•΄μ•Ό ν•λ” κ²ƒμ€ μ•„λ‹
- @Transactional μ‚¬μ©μ€ **ν¬μΈνΈμ»·**κ³Ό **νΈλμ­μ… μ†μ„±** μ§€μ •ν•λ” κ²ƒλ³΄λ‹¤ **λ‹¨μ**ν•κ³  **μ§κ΄€μ **μ΄κΈ° λ•λ¬Έμ— @Transactionalμ„ μ£Όλ΅ μ‚¬μ©ν•κΈ°λ„ ν•¨
- ν•μ§€λ§, @Transactionalμ„ λΉΌ λ¨Ήμ–΄λ„ μ»΄νμΌμ— μ•„λ¬΄λ° λ¬Έμ κ°€ μ—†κ³  λ΅¤λ°±μ΄ λ°μƒν–μ„ λ• λΉΌ λ¨Ήμ€ μ‚¬μ‹¤μ„ μ• μ μκΈ° λ•λ¬Έμ— λ§¤μ° μ΅°μ‹¬ν•΄μ„ μ‚¬μ©ν•΄μ•Ό ν•¨
- μ•„λ xml νμΌ μ„¤μ •μ„ @Transactionalλ΅ μ‰½κ² λ°”κΏ€ μ μμ
    
    ```xml
    <beans
    		...>
    		...
    		<tx:advice id="transactionAdvice">
            <tx:attributes>
                <!--propagationμ΄ "REQUIRED"μΌ κ²½μ° μƒλµ κ°€λ¥-->
                <tx:method name="get*" read-only="true"/>
                <tx:method name="*" />
            </tx:attributes>
        </tx:advice>
    </beans>
    ```
    
- UserServiceImplμ™€ TestService λ‘ κ°μ ν΄λμ¤μ— μ μ©ν•κΈ° μ„ν•΄ μΈν„°νμ΄μ¤μΈ UserServiceμ—μ„ @Transactional μ‚¬μ©
    
    ```java
    @Transactional
    public interface UserService {
    		//<tx:method name="*" />μ™€ κ°™μ
        void add(User user);
        void deleteAll();
        void update(User user1);
        void upgradeLevels();
    
    		//<tx:method name="get*" read-only="true"/>μ™€ κ°™μ
        @Transactional(readOnly = true)
        User get(String id);
    
        @Transactional(readOnly = true)
        List<User> getAll();
    }
    ```