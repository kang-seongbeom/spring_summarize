# 5.1 ì„œë¹„ìŠ¤ ì¶”ìƒí™”

5.1.1 ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€

- UserDaoëŠ” CRUDë¥¼ ì œì™¸í•˜ê³  ì–´ë–¤ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**ì„ ê°–ì§€ ì•ŠìŒ
- ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë“ˆ ê¸°ëŠ¥ ì¶”ê°€
- ì •ê¸°ì ìœ¼ë¡œ ìœ ì €ì˜ í™œìš© ë‚´ìš©ì„ ì°¸ì¡°í•´ì„œ ë ˆë²¨ì„ ì¡°ì •
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    - ì‚¬ìš©ìì˜ ë ˆë²¨ì€ BASIC, SILVER, GOLD ì„¸ ê°€ì§€ ì¤‘ í•˜ë‚˜
    - ì²˜ìŒ ê°€ì…ìë©´ BASIC. í™œë™ì— ë”°ë¼ í•œ ë‹¨ê³„ì”© ì—…ê·¸ë ˆì´ë“œ
    - ê°€ì…í›„ 50íšŒ ì´ìƒ ë¡œê·¸ì¸ í•˜ë©´ BASIC â†’ SILVER
    - SILVER ì´ë©´ì„œ 30ë²ˆ ì´ìƒ ì¶”ì²œì„ ë°›ìœ¼ë©´ GOLD
    - ë ˆë²¨ ë³€ê²½ ì‘ì—…ì€ **ì¼ì • ì£¼ê¸°**ë¥¼ ê°€ì§€ê³  **ì¼ê´„ì **ìœ¼ë¡œ ì§„í–‰
    

5.1.2 ì •ìˆ˜í˜• ìƒìˆ˜ ê°’ì˜ ì‚¬ìš©ì ë ˆë²¨

- ê° ë ˆë²¨ì„ ì½”ë“œí™” í•´ì„œ ìˆ«ìë¡œ ë„£ìŒ
    
    ```java
    public class User {
    		...
        int level;
        private static final int BASIC = 1;
        private static final int SILVER = 2;
        private static final int GOLD = 3;
    
        public void setLevel(int level){
            this.level = level;
        }
    }
    ```
    
- ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì •ë³´ë¥¼ ë„£ëŠ” ì‹¤ìˆ˜ë¥¼ í•´ë„ **ì»´íŒŒì¼ëŸ¬**ê°€ ì²´í¬í•˜ì§€ ëª»í•˜ëŠ” ë‹¨ì  ì¡´ì¬
    
    ```java
    user1.setLevel(1000);
    ```
    

5.1.3 Level ì´ëŠ„(Enum) ì¶”ê°€

- ë ˆë²¨ì„ ë‚˜íƒ€ë‚¼ ìˆ«ìë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ ì•ˆì „
- Level ì´ëŠ„ **ë‚´ë¶€**ì—ëŠ” DBì— ì €ì¥í•  **int íƒ€ì…**ì˜ ê°’ì„ ê°–ê³  ìˆì§€ë§Œ, **ê²‰ìœ¼ë¡œëŠ” Level íƒ€ì…ì˜ ì˜¤ë¸Œì íŠ¸**ì´ê¸° ë•Œë¬¸ì— ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
- valueOf()ë¡œ Level ì˜¤ë¸Œì íŠ¸ë¥¼ ë°›ìŒ

```java
public enum Level {
    BASIC(1), SILVER(2), GOLD(3);

    private final int value;

    Level(int value){
        this.value = value;
    }

    public int intValue(){
        return value;
    }

    public static Level valueOf(int value){
        switch (value){
            case 1: return BASIC;
            case 2: return SILVER;
            case 3: return GOLD;
            default: throw new AssertionError("Unknown value : " + value);
        }
    }
}
```

5.1.4 User í•„ë“œì¶”ê°€

- ë ˆë²¨ ê´€ë¦¬ ë¡œì§ì—ì„œ ì–¸ê¸‰ëœ **ë¡œê·¸ì¸ íšŸìˆ˜**ì™€ **ì¶”ì²œìˆ˜** ì¶”ê°€

| í•„ë“œëª… | íƒ€ì… | ì„¤ì • |
| --- | --- | --- |
| level | tinyint | Not NullKey |
| login | int | Not Null |
| recommend | int | Not Null |

```sql
ALTER TABLE users ADD level tinyint not null;
ALTER TABLE users ADD login int not null;
ALTER TABLE users ADD recommend int not null;
```

```java
public class User {
		...
    Level level;
    int login;
    int recommend;

		public User(String id, String name, String password, 
								Level level, int login, int recommend) {
        this.id = id;
        this.name = name;
        this.password = password;
        this.level = level;
        this.login = login;
        this.recommend = recommend;
    }
		... //getter, setter
}
```

5.1.5 í…ŒìŠ¤íŠ¸ ìˆ˜ì •

- addAndGet()ì—ì„œ assertThat()ë¥¼ ì¼ì •í•œ ë¡œì§ì„ ìœ„í•´ checkSameUser()ë¡œ ëŒ€ì²´

```java
public class UserDaoTest {
		...
    private final User user1 = new User("gyumee", "k1n", "k1p",
            Level.BASIC, 1, 0);
    private final User user2 = new User("leegw700", "k2n", "k2p",
            Level.SILVER, 55, 10);
    private final User user3 = new User("bumjin", "k3n", "k3p",
            Level.GOLD, 100, 40);
	
		private void checkSameUser(User pUser1, User pUser2) {
        assertThat(pUser1.getId(), is(pUser2.getId()));
        assertThat(pUser1.getName(), is(pUser2.getName()));
        assertThat(pUser1.getPassword(), is(pUser2.getPassword()));
        assertThat(pUser1.getLevel(), is(pUser2.getLevel()));
        assertThat(pUser1.getLogin(), is(pUser2.getLogin()));
        assertThat(pUser1.getRecommend(), is(pUser2.getRecommend()));
    }

		@Test
    public void addAndGet() {
        ...
        User userGet1 = dao.get(user1.getId());
        checkSameUser(userGet1, user1);

        User userGet2 = dao.get(user2.getId());
        checkSameUser(userGet2, user2);
    }
		...
}
```

5.1.6 UserDaoJdbc ìˆ˜ì •

- Insert SQLë¬¸ ë° ì¡°íšŒ ì‘ì—…ì— ì‚¬ìš©ë˜ëŠ” userMapper ìˆ˜ì •
- ì´ëŠ„ì€ DBì— ì €ì¥ë  ìˆ˜ ìˆëŠ” SQL íƒ€ì…ì´ ì•„ë‹˜
- ë”°ë¼ì„œ, DBì— ì €ì¥ ê°€ëŠ¥í•œ **ì •ìˆ˜í˜• ê°’**ìœ¼ë¡œ ë³€í™˜í•´ì•¼ í•¨
- Level ì´ëŠ„ì˜  **intValue()**ë¡œ insertë¬¸ ì•ˆì— ë„£ì„ ë ˆë²¨ë³„ int ê°’ì„ ê°€ì ¸ì˜¤ê³ , **valueOf()**ë¡œ ë ˆë²¨ ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì˜´

```java
public class UserDaoJdbc implements UserDao{
    private RowMapper<User> userMapper =
            new RowMapper<User>() {
                @Override
                public User mapRow(ResultSet rs, int rowNum)
                        throws SQLException {
                    ...
                    user.setLevel(Level.valueOf(rs.getInt("level")));
                    user.setLogin(rs.getInt("login"));
                    user.setRecommend(rs.getInt("recommend"));
                    return user;
                }
            };
		
		public void add(final User user) {
        ...
        int level = user.getLevel().intValue();
        int login = user.getLogin();
        int recommend = user.getRecommend();
        String query = "insert into users(id, name, password, " +
                "level, login, recommend) value (?,?,?,?,?,?)";
        this.jdbcTemplate.update(query, id, name, password, 
                level, login, recommend);
    }
}
```

<aside>
ğŸ’¡ ë§ì€ ì¶”ê°€ ë° ìˆ˜ì •ì´ ìˆì§€ë§Œ, í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ë•ë¶„ì— ì˜¤ë¥˜ë¥¼ ì²´í¬í•  ìˆ˜ ìˆì—ˆìŒ

</aside>

5.1.7 ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€

- idë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í•„ë“œëŠ” ìˆ˜ì •í•  ìˆ˜ ìˆìŒ
- updateë¥¼ í†µí•´ ì‚¬ìš©ì ìˆ˜ì •

```java
public class UserDaoTest {
		...
		@Test
    public void update(){
        dao.deleteAll();
        dao.add(user1);

        user1.setName("ksb");
        user1.setPassword("ksb-p");
        user1.setLevel(Level.GOLD);
        user1.setLogin(1000);
        user1.setRecommend(999);
        dao.update(user1);

        User user1Update = dao.get(user1.getId());
        checkSameUser(user1, user1Update);
    }
}

public interface UserDao {
		...
		void update(User user1);
}

public class UserDaoJdbc implements UserDao {
		...
		public void update(User user1) {
        String query = "update users set name=?, password=?, level=?, " +
                "login=?, recommend=? where id=?";
        String id = user1.getId();
        String name = user1.getName();
        String password = user1.getPassword();
        int level = user1.getLevel().intValue();
        int login = user1.getLogin();
        int recommend = user1.getRecommend();
        this.jdbcTemplate.update(query, name, password,
                level, login, recommend, id);
    }
}
```

5.1.8 ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë³´ì™„

- updateì˜ whereê°€ ì—†ì–´ë„ ì •ìƒì ìœ¼ë¡œ ë™ì‘(ë‹¨, ëª¨ë“  ë¡œìš°ì˜ idë¥¼ ì œì™¸í•œ í•„ë“œ ê°’ ë³€ê²½)
- ë³´ì™„ ë°©ë²• ë‘ ê°€ì§€ ì¡´ì¬
    1. ì˜í–¥ ë°›ì€ ë¡œìš° ê°œìˆ˜ í™•ì¸
    2. ì§ì ‘ í™•ì¸
- updateë‚˜ deleteì™€ ê°™ì´ í…Œì´ë¸”ì˜ ë‚´ìš©ì— ì˜í–¥ì„ ì£¼ëŠ” SQL ë¬¸ì„ ì‹¤í–‰í•˜ë©´ ì˜í–¥ ë°›ì€ ë¡œìš°ì˜ ê°œìˆ˜ë¥¼ ë°˜í™˜í•¨
- add(), deleteAll(), update() ë©”ì†Œë“œ ë¦¬í„´ íƒ€ì…ì„ intë¡œ ë°”ê¾¸ë©´ ì˜í–¥ë°›ì€ ë¡œìš°ì˜ ê°œìˆ˜ë¥¼ ì•Œ ìˆ˜ ìˆìŒ
- ë‘ ëª…ì˜ ì‚¬ìš©ìë¥¼ ë“±ë¡í•˜ê³  ì›í•˜ëŠ” ì‚¬ìš©ì ì´ì™¸ì— ì •ë³´ê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ í™•ì¸

```java
public class UserDaoTest {
		...
		@Test
    public void update(){
        dao.deleteAll();
        dao.add(user1);
        dao.add(user2);

        user1.setName("ksb");
        user1.setPassword("ksb-p");
        user1.setLevel(Level.GOLD);
        user1.setLogin(1000);
        user1.setRecommend(999);
        dao.update(user1);

        User user1Update = dao.get(user1.getId());
        checkSameUser(user1, user1Update);

        User user2same = dao.get(user2.getId());
        checkSameUser(user2, user2same);
    }
}
```

5.1.9 UserService í´ë˜ìŠ¤ì™€ ë¹ˆ ë“±ë¡

- DAOëŠ” ë°ì´í„°ë¥¼ ì¡°íšŒ ë° ì¡°ì‘ì„ ë‹´ë‹¹í•˜ëŠ” ê³³ì„
- ì‚¬ìš©ì ê´€ë¦¬ ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ DAOì— ë‹´ëŠ” ê²ƒì€ ì ë‹¹í•˜ì§€ ì•ŠìŒ
- ì‚¬ìš©ì ê´€ë¦¬ ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ UserService í´ë˜ìŠ¤ì— ë‹´ìŒ
- UserServiceëŠ” UserDaoì˜ êµ¬í˜„ í´ë˜ìŠ¤ê°€ ë°”ë€Œì–´ë„ ì˜í–¥ì„ ë°›ìœ¼ë©´ ì•ˆë¨
- ë•Œë¬¸ì—, DAOì˜ ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©ìœ¼ë¡œ DIë¥¼ ì ìš©
- DI ë°›ê¸° ìœ„í•´ì„œ UserServiceë„ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì•¼í•¨

![https://media.vlpt.us/images/devsigner9920/post/eca48521-b42f-452b-a075-01dc47cc75a7/258E371C-2076-44C7-8888-92B2E9D3681E.png?w=768](https://media.vlpt.us/images/devsigner9920/post/eca48521-b42f-452b-a075-01dc47cc75a7/258E371C-2076-44C7-8888-92B2E9D3681E.png?w=768)

```java
public class UserService {
    UserDao userDao;
    
    public void setUserDao(UserDao userDao){
        this.userDao = userDao;
    }
}

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "/applicationContext.xml")
public class UserServiceTest {
    @Autowired
    UserService userService;

    @Test
    public void bean(){
        assertThat(this.userService, is(notNullValue()));
    }
}
```

```xml
<beans
		...>
    <bean id="userService" class="com.ksb.spring.UserService">
        <property name="userDao" ref="userDao"/>
    </bean>
    <bean id="userDao" class="com.ksb.spring.UserDaoJdbc">
        <property name="dataSource" ref="dataSource"/>
    </bean>
<beans>
```

5.1.10 upgradeLevels() ë©”ì†Œë“œ

- ë¹„ì¦ˆë‹ˆìŠ¤ì— ë§ì¶° userì˜ levelì„ ì—…ê·¸ë ˆì´ë“œ í•˜ëŠ” ë¡œì§ êµ¬í˜„
- ê²½ê³„ ê°’ì„ ë‚˜ëˆ  ì •ìƒì ìœ¼ë¡œ level ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ”ì§€ í™•ì¸

```java
public class UserServiceTest {
    @Autowired
    UserService userService;
    @Autowired
    UserDao userDao;
    List<User> users;

    @Before
    public void setUp(){
        users = Arrays.asList(
                new User("k1", "k1", "k1", Level.BASIC, 49 ,0),
                new User("k2", "k2", "k2", Level.BASIC, 50 ,0),
                new User("k3", "k3", "k3", Level.SILVER, 60 ,29),
                new User("k4", "k4", "k4", Level.SILVER, 60 ,30),
                new User("k5", "k5", "k5", Level.GOLD, 100 ,100)
        );
    }

    @Test
    public void upgradeLevels(){
        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        userService.upgradeLevels();

        checkLevel(users.get(0), Level.BASIC);
        checkLevel(users.get(1), Level.SILVER);
        checkLevel(users.get(2), Level.SILVER);
        checkLevel(users.get(3), Level.GOLD);
        checkLevel(users.get(4), Level.GOLD);
    }

    //ì—…ê·¸ë ˆì´ë“œ ì´í›„ ê¸°ëŒ€í•œ ê°’ì´ ë§ëŠ”ì§€ í™•ì¸
    private void checkLevel(User user, Level expectedLevel) {
        User userUpdate = userDao.get(user.getId());
        assertThat(userUpdate.getLevel(), is(expectedLevel));
    }
}

public class UserService {
		...
		public void upgradeLevels() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            Boolean changed = null;
            if (user.getLevel() == Level.BASIC && user.getLogin() >= 50) {
                user.setLevel(Level.SILVER); //basic ì—…ê·¸ë ˆì´ë“œ
                changed = true;
            } else if (user.getLevel() == Level.SILVER && user.getRecommend() >= 30) {
                user.setLevel(Level.GOLD); //silver ì—…ê·¸ë ˆì´ë“œ
                changed = true;
            } else if (user.getLevel() == Level.GOLD) {
                changed = false;
            } else {
                changed = false;
            }
            //level ë³€ê²½ì´ ë°œìƒ í•  ê²½ìš°
            if (changed) userDao.update(user);
        }
    }
}
```

5.1.11 ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

- ì²˜ìŒ ê°€ì…í•œ ì‚¬ìš©ìëŠ” ê¸°ë³¸ì ìœ¼ë¡œ BASIC ë ˆë²¨ì´ì–´ì•¼ í•˜ëŠ” ë¡œì§ì´ êµ¬í˜„ ì•ˆë¨
- UserDaoJdbcëŠ” ì£¼ì–´ì§„ DBì •ë³´ë¥¼ ë„£ê³  ë¹¼ëŠ” ë°©ë²•ì—ë§Œ ê´€ì‹¬ì„ ê°€ì ¸ì•¼ì§€, ì´ëŸ° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë„£ê¸°ì— ì í•©í•˜ì§€ ì•ŠìŒ
- UserServiceê°€ ì í•©í•¨
- User ì˜¤ë¸Œì íŠ¸ì˜ ë ˆë²¨ì´ ë¹„ì–´ìˆìœ¼ë©´ BASICìœ¼ë¡œ ì„¤ì •í•˜ê³ , ë¯¸ë¦¬ ì„¤ì •ëœ ë ˆë²¨ì´ ìˆìœ¼ë©´ ìœ ì§€í•˜ëŠ” ë¡œì§ìœ¼ë¡œ êµ¬í˜„
- ë¡œì§ ì‹¤í–‰ ì´í›„ get()ì„ ì´ìš©í•´ DBì— ì €ì¥ëœ User ì •ë³´ë¥¼ ê°€ì ¸ì™€ í™•ì¸í•˜ë©´, UserServiceê°€ UserDaoë¥¼ ì œëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ”ì§€ ê²€ì¦ì„ í•  ìˆ˜ ìˆê³ , ë””í´íŠ¸ ë ˆë²¨ ì„¤ì • í›„ UserDaoë¥¼ í˜¸ì¶œí•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ

```java
public class UserServiceTest {
		...
		@Test
    public void add(){
        userDao.deleteAll();

        User userWithLevel = users.get(4); //gold ìœ ì €ëŠ” ë ˆë²¨ ë³€ê²½ ì—†ìŒ
        User userWithoutLevel = users.get(0);
        userWithoutLevel.setLevel(null);

        userService.add(userWithLevel);
        userService.add(userWithoutLevel);

        User userWithLevelRead = userDao.get(userWithLevel.getId());
        User userWithoutLevelRead = userDao.get(userWithoutLevel.getId());

        assertThat(userWithLevelRead.getLevel(), is(userWithLevel.getLevel()));
        assertThat(userWithoutLevelRead.getLevel(), is(userWithoutLevel.getLevel()));
    }
}

public class UserService {
		...
		public void add(User user) {
        if(user.getLevel() == null) user.setLevel(Level.BASIC);
        userDao.add(user);
    }
}
```

5.1.12 upgradeLevels()ì˜ ë¬¸ì œì  ê³¼ ë¦¬íŒ©í† ë§ - 1

- upgradeLevels()ëŠ” ë ˆë²¨ íŒŒì•…, ì—…ë ˆì´ë“œ ì¡°ê±´, í”Œë˜ê·¸ ë“±ì´ ì¡´ì¬
- ë˜í•œ, if ì¡°ê±´ì´ ë ˆë²¨ ê°œìˆ˜ë§Œí¼ ë°˜ë³µ
- canUpgradeLevel()ë¡œ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œì§€ í™•ì¸
- ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•˜ë©´ upgradeLevel()ë¡œ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ
- upgradeLevel() ì²˜ëŸ¼ ì—…ê·¸ë ˆì´ë“œ ë¶€ë¶„ì„ ë¶„ë¦¬í•˜ë©´ ë‚˜ì¤‘ì— ì•ˆë‚´ ë©”ì¼, ë¡œê·¸, í†µë³´ì™€ ê°™ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì¶”ê°€í•  ë•Œ í¸ë¦¬í•¨

```java
public class UserService {
		...
		public void upgradeLevels() {
        List<User> users = userDao.getAll();
        for (User user : users) {
            if(canUpgradeLevel(user)){
                upgradeLevel(user);
            }
        }
    }
    
    private boolean canUpgradeLevel(User user) {
        Level currentLevel = user.getLevel();

        switch (currentLevel){
            case BASIC: return user.getLogin()>=50;
            case SILVER:return user.getRecommend()>=30;
            case GOLD:return false;
            default:throw new IllegalArgumentException("Unknown Level: "
																											+ currentLevel);
        }
    }

    private void upgradeLevel(User user) {
        if(user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
        else if(user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD);
        userDao.update(user);
    }
}
```

5.1.13 upgradeLevels()ì˜ ë¬¸ì œì  ê³¼ ë¦¬íŒ©í† ë§ - 2

- upgradeLevels()ëŠ” ì•„ì§ ë§ì€ ë¬¸ì œë¥¼ ê°€ì§€ê³  ìˆìŒ
- **ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨**ì´ ë¬´ì—‡ì¸ê°€ í•˜ëŠ” ë¡œì§ê³¼ **ì‚¬ìš©ì ì˜¤ë¸Œì íŠ¸ì˜ level í•„ë“œ**ë¥¼ ë³€ê²½í•´ ì¤€ë‹¤ëŠ” ë¡œì§ì´ ê°™ì´ ìˆê³  **ì˜ˆì™¸ ì²˜ë¦¬**ê°€ ì—†ìŒ
- ë•Œë¬¸ì— ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ì— ëŒ€í•œ ë¡œì§ì´ UserServiceì— ìˆì„ í•„ìš”ê°€ ì—†ìŒ
- í•´ë‹¹ ë¡œì§ì„ **Level ì´ëŠ„**ì— ë„˜ê¹€
- Level ì´ëŠ„ì— ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ ì •ë³´ë¥¼ ë‹´ì„ ìˆ˜ ìˆëŠ” í•„ë“œ ì¶”ê°€

```java
public enum Level {
    GOLD(3, null), SILVER(2, GOLD), BASIC(1, SILVER);

    private final int value;
    private final Level next;

    Level(int value, Level next){
        this.value = value;
        this.next = next;
    }
    
    public Level nextLevel(){
        return this.next;
    }
		...
}
```

5.1.14 User ì˜¤ë¸Œì íŠ¸ì˜ ë‚´ë¶€ì •ë³´ ë³€ê²½

- ì‚¬ìš©ì ì •ë³´ê°€ ë³€ê²½ë˜ëŠ” ë¶€ë¶„ì„ UserServiceì—ì„œ Userë¡œ ì˜®ê¹€
- UserëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” ë‹¨ìˆœí•œ ìë°”ë¹ˆì´ê¸´ í•˜ì§€ë§Œ, Userë„ ìë°” ì˜¤ë¸Œì íŠ¸ ì´ë©° **ë‚´ë¶€ ì •ë³´**ë¥¼ ë‹¤ë£¨ëŠ” ê¸°ëŠ¥ì´ ìˆì„ ìˆ˜ ìˆìŒ
- ë”°ë¼ì„œ, **UserServiceê°€** ì¼ì¼ì´ User ì˜¤ë¸Œì íŠ¸ì˜ í•„ë“œ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, User ì˜¤ë¸Œì íŠ¸ì—ê²Œ **í•„ë“œë¥¼ ë³€ê²½í•˜ë¼ê³  ìš”ì²­**ì„ í•˜ëŠ”ê²ƒì´ ì ì ˆí•¨

```java
public class User {
		...
		public void upgradeLevel() {
        Level netLevel = this.level.nextLevel();
        if (netLevel == null)
            throw new IllegalStateException(this.level + "ì€ ì—…ê·¸ë ˆì´ë“œ ë¶ˆê°€");
        else
            this.level = netLevel;
    }
}

public class UserService {
		...
		private void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
    }
}
```

5.1.15 ë¦¬íŒ©í† ë§ ê²°ê³¼

- ì½”ë“œê°€ ê°„ê²°í•´ì§€ê³ , ì‘ì—… ë‚´ìš© ë° ì±…ì„ì´ ë¶„ë¦¬ë¨
- ìì‹ ì˜ ì±…ì„ì— ì¶©ì‹¤í•œ ê¸°ëŠ¥ì„ ê°–ê³  ìˆìœ¼ë©´ì„œ, ì‘ì—… ìˆ˜í–‰ì‹œ ì‘ì—…ì„ ìš”ì²­í•˜ëŠ”êµ¬ì¡°ì„
- **ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œ**ëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì‘ì—…í•˜ëŠ” ëŒ€ì‹ , ë°ì´í„°ë¥¼ ê°–ê³  ìˆëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì—ê²Œ **ì‘ì—…ì„ ìš”ì²­**í•˜ëŠ” ê²ƒì„
- UserServiceëŠ” Userì—ê²Œ â€œë ˆë²¨ ì—…ê·¸ë ˆì´ë“œâ€  ìš”ì²­í•˜ê³ , UserëŠ” Levelì—ê²Œ â€œë‹¤ìŒ ë ˆë²¨â€ì— ëŒ€í•œ ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” êµ¬ì¡°ë¡œ ë³€ê²½ëìŒ
- ì´ ì½”ë“œëŠ” ì™„ë²½í•˜ì§€ëŠ” ì•Šì§€ë§Œ, ìŠ¤í”„ë§ ê¸°ëŠ¥ì„ ì ìš©í•˜ê¸° ì ì ˆí•œ êµ¬ì¡°ë¡œ ë§Œë“ ê²ƒì„

5.1.16 User í…ŒìŠ¤íŠ¸

- Userì— ê°„ë‹¨í•˜ì§€ë§Œ ë¡œì§ì„ ë‹´ì€ ë©”ì†Œë“œ(upgradeLevel())ì„ ì¶”ê°€í–ˆìŒ
- ì•ìœ¼ë¡œ ê³„ì† ìƒˆë¡œìš´ ê¸°ëŠ¥ê³¼ ë¡œì§ì´ ì¶”ê°€ë  ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë‹ˆ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ë©´ í¸í•¨
- User ì˜¤ë¸Œì íŠ¸ëŠ” ìŠ¤í”„ë§ì´ IoC ë°©ì‹ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì˜¤ë¸Œì íŠ¸ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— **ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸**ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¨
- **í…ŒìŠ¤íŠ¸**ì— ì¡´ì¬í•˜ëŠ” upgradeLevel()ì€ Level ì´ëŠ„ì— ì •ì˜ëœ ëª¨ë“  ë ˆë²¨ì„ ê°€ì ¸ì™€ì„œ Userì— ì €ì¥í•˜ê³ , **User**ì˜ upgradeLevel()ì„ ì‹¤í–‰í•´ì„œ ë‹¤ìŒ ë ˆë²¨ë¡œ ë³€í•˜ëŠ”ì§€ í™•ì¸
    
    <aside>
    ğŸ’¡ ê°™ì€ ë©”ì†Œë“œ ì´ë¦„ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— í—·ê°ˆë¦¬ë©´ ì•ˆë¨
    
    </aside>
    

```java
public class UserTest {
    User user;
    
    @Before
    public void setUp(){
        user = new User();
    }

    @Test
    public void upgradeLevel(){
        Level[] levels = Level.values();
        for(Level level : levels){
            if(level.nextLevel() == null) continue;
            user.setLevel(level);
            user.upgradeLevel();
            assertThat(user.getLevel(), is(level.nextLevel()));
        }
    }

    @Test(expected = IllegalStateException.class)
    public void cannotUpgradeLevel(){
        Level[] levels = Level.values();
        for(Level level : levels){
            if(level.nextLevel() != null) continue;
            user.setLevel(level);
            user.upgradeLevel();
        }
    }
}
```

5.1.17 UserServiceTest ê°œì„ 

- UserServiceTestì˜ upgradeLevels()ëŠ” ëª…í™•í•œ ì½”ë“œê°€ ì•„ë‹˜
- ê¸°ì¡´ì˜ checkLevel()ë¡œ ë„˜ê¸°ëŠ” ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¥¼ ì—…ê·¸ë ˆì´ë“œ ê¸°ëŒ“ê°’ì´ ì•„ë‹Œ, bool ê°’ìœ¼ë¡œ í™•ì¸

```java
//ë³€ê²½ì „
public class UserServiceTest {
		...
		@Test
    public void upgradeLevels(){
        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        userService.upgradeLevels();

        checkLevel(users.get(0), Level.BASIC);
        checkLevel(users.get(1), Level.SILVER);
        checkLevel(users.get(2), Level.SILVER);
        checkLevel(users.get(3), Level.GOLD);
        checkLevel(users.get(4), Level.GOLD);
    }

    //ì—…ê·¸ë ˆì´ë“œ ì´í›„ ê¸°ëŒ€í•œ ê°’ì´ ë§ëŠ”ì§€ í™•ì¸
    private void checkLevel(User user, Level expectedLevel) {
        User userUpdate = userDao.get(user.getId());
        assertThat(userUpdate.getLevel(), is(expectedLevel));
    }
}

//ë³€ê²½í›„
public class UserServiceTest {
		...
		@Test
    public void upgradeLevels(){
        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        userService.upgradeLevels();

        checkLevelUpgraded(users.get(0), false);
        checkLevelUpgraded(users.get(1), true);
        checkLevelUpgraded(users.get(2), false);
        checkLevelUpgraded(users.get(3), true);
        checkLevelUpgraded(users.get(4), false);
    }

    private void checkLevelUpgraded(User user, boolean upgraded) {
        User userUpdate = userDao.get(user.getId());
        if(upgraded){
            assertThat(userUpdate.getLevel(), is(user.getLevel().nextLevel()));
        }else{
            assertThat(userUpdate.getLevel(), is(user.getLevel()));
        }
    }
}
```

5.1.18 UserService ê°œì„ 

- ë¡œê·¸ì¸ ë° ì¶”ì²œ íšŸìˆ˜ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ì™€ í…ŒìŠ¤íŠ¸ ì½”ë“œì— ì¤‘ë³µë¼ì„œ ë‚˜íƒ€ë‚¨
- ì •ìˆ˜í˜• ìƒìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ ë³€ê²½

```java
public class UserService {
    public static final int MIN_LOG_COUNT_FOR_SILVER = 50;
    public static final int MIN_RECOMMEND_FOR_GOLD = 30;

		private boolean canUpgradeLevel(User user) {
        Level currentLevel = user.getLevel();

        switch (currentLevel) {
            case BASIC:
                return user.getLogin() >= MIN_LOG_COUNT_FOR_SILVER;
            case SILVER:
                return user.getRecommend() >= MIN_RECOMMEND_FOR_GOLD;
            case GOLD:
                return false;
            default:
                throw new IllegalArgumentException("Unknown Level: " + currentLevel);
        }
    }
		...
}

import static com.ksb.spring.UserService.MIN_LOG_COUNT_FOR_SILVER;
import static com.ksb.spring.UserService.MIN_RECOMMEND_FOR_GOLD;
public class UserServiceTest {
    ...
    @Before
    public void setUp() {
        users = Arrays.asList(
                new User("k1", "k1", "k1", Level.BASIC,
                        MIN_LOG_COUNT_FOR_SILVER - 1, 0),
                new User("k2", "k2", "k2", Level.BASIC,
                        MIN_LOG_COUNT_FOR_SILVER, 0),
                new User("k3", "k3", "k3", Level.SILVER,
                        60, MIN_RECOMMEND_FOR_GOLD - 1),
                new User("k4", "k4", "k4", Level.SILVER,
                        60, MIN_RECOMMEND_FOR_GOLD),
                new User("k5", "k5", "k5", Level.GOLD,
                        100, Integer.MAX_VALUE)
        );
		...
    }
}
```

5.1.19 ì—…ê·¸ë ˆì´ë“œ ì •ì±…

- ì´ë²¤íŠ¸ì™€ ê°™ì´ ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì¼ ì¼ì‹œì ìœ¼ë¡œ ë³€ê²½ë˜ëŠ” ì¼ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ
- ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ UserServiceì—ì„œ ë¶„ë¦¬ í•˜ëŠ” ë°©ë²•ì„ ê³ ë ¤í•˜ë©´ ë¨
- ë¶„ë¦¬ëœ ì •ì±…ì„ DIì„ í†µí•´ UserServiceì— ì£¼ì…
- ì´ë²¤íŠ¸ ì¢…ë£Œì‹œ DIë§Œ ì œê±°í•˜ë©´ ë¨

<aside>
ğŸ’¡ ì±…ì—ë„ ì‹¤ìŠµ ì°¨ì›ì—ì„œ í•˜ë¼ê³ ë§Œ ë‚˜ì™€ìˆìŒ

</aside>

```java
public interface UserLevelUpgradePolicy {
    boolean canUpgradeLevel(User user);
    void upgradeLevel(User user);
}
```