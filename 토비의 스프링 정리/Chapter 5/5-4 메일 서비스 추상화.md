# 5.4 ë©”ì¼ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

5.4.1 JavaMailì„ ì´ìš©í•œ ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥

- ìƒˆë¡œìš´ ìš”êµ¬ì‚¬í•­ ë“±ì¥
- ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œëœ ìœ ì €ì—ê²Œ ì•ˆë‚´ ë©”ì¼ì„ ë³´ë‚´ëŠ” ê¸°ëŠ¥ ì¶”ê°€
- DBì— email í•„ë“œ ì¶”ê°€
- UserDaoì˜ userMapper, insert(), update()ì— emial í•„ë“œ ì²˜ë¦¬ ì¶”ê°€
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë§ê²Œ ì¤€ë¹„ ë° ë“±ë¡, ìˆ˜ì •, ì¡°íšŒì—ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜ì •

<aside>
ğŸ’¡ ì•ìœ¼ë¡œ í•  ë¶€ë¶„ì— email ë¶€ë¶„ì„ êµ³ì´ í•„ìš”ë¡œ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¶”ê°€ ì•ˆí• ê²ƒì„

</aside>

5.4.2 JavaMail ë°œì†¡

- JavaMailì„ ì´ìš©í•´ ë©”ì¼ì„ ë°œì†¡í•˜ëŠ” ì „í˜•ì ì¸ ì½”ë“œ
- ë‹¨ìˆœí•œ ì˜ˆì œì´ë¯€ë¡œ í•œê¸€ ì¸ì½”ë”© ë¶€ë¶„ ìƒëµ
- SMTP í”„ë¡œí† ì½œì„ ì§€ìš°ë„ˆí•˜ëŠ” **ë©”ì¼ ì „ì†¡ ì„œë²„**ê°€ ì¤€ë¹„ ë˜ì—ˆë‹¤ë©´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë  ê²ƒì„

```java
public class UserService {
		...
		protected void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
        //sendUpdateEmail(user); 
    }
		private void sendUpgradeEmail(User user){
        Properties props = new Properties();
        props.put("mail.smtp.host", "mail.ksug.org");

        Session s = Session.getInstance(props, null);
        MIMEMessage message = new MIMEMessage(s);
        try{
            message.setFrom(new InternetAddress("useradmin@ksug.org"));
            message.addRecipient(Messasge.RecipientType.TO,
                    new InternetAddress(user.getEmail()));
            message.setSubject("Upgrade ì•ˆë‚´");
            message.setText("ì‚¬ìš©ìë‹˜ì˜ ë“±ê¸‰ì´ " + user.getLevel().name() + 
																"ë¡œ ì—…ê·¸ë ˆì´ë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            Transport.send(message);
        } catch (AddressException e){
            throw new RuntimeException(e);
        } catch (MessagingException e){
            throw new RuntimeException(e);
        } catch (UnsupportedEncodingException e){
            throw new RuntimeException(e);
        }
    }
}
```

5.4.3 JavaMailì´ í¬í•¨ëœ ì½”ë“œì˜ í…ŒìŠ¤íŠ¸

- ë©”ì¼ ì „ì†¡ ì„œë²„ëŠ” ë§¤ìš° ë¶€í•˜ê°€ í° ì‘ì—…ì„
- ë©”ì¼ ì„œë²„ê°€ ì¤€ë¹„ë˜ì§€ ì•Šìœ¼ë©´ ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ
- ë˜í•œ, ì„œë²„ê°€ ì¤€ë¹„ë˜ì—ˆë‹¤ í•´ë„ í…ŒìŠ¤íŠ¸ í•  ë•Œ ë§ˆë‹¤ ë©”ì¼ ì„œë²„ë¥¼ ë™ì‘ì‹œí‚¤ëŠ” ê²ƒì€ ì˜³ì§€ ëª»í•¨
- ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ì€ ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ì˜ **ë³´ì¡°ì ì¸ ê¸°ëŠ¥**ì¼ ë¿ì„
- ë”°ë¼ì„œ, ì—…ê·¸ë ˆì´ë“œ ë°œìƒë˜ê³  DBì— ì˜ ë°˜ì˜ ë˜ëŠ”ì§€ ë§Œí¼ ì¤‘ìš”í•˜ì§€ ì•ŠìŒ
- ë˜í•œ, ë©”ì¼ì„ ë°œì†¡í–ˆë‹¤ í•´ë„ ëª©ì ì§€ì— **ì‹¤ì œë¡œ ë„ì°©**ì„ í–ˆëŠ”ì§€ í™•ì¸í•˜ì§€ ëª»í•˜ë¯€ë¡œ ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤ë¼ê³  í•  ìˆ˜ ìˆìŒ
- í•˜ì§€ë§Œ, ë©”ì¼ ì„œë²„ëŠ” ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ëœ ì‹œìŠ¤í…œì´ê¸° ë•Œë¬¸ì— JavaMailì„ í†µí•´ **ë©”ì¼ ì„œë²„ê¹Œì§€ë§Œ** ì˜ ì „ë‹¬ì´ ë˜ë©´ ë³„ë¬¸ì œ ì—†ì´ ë©”ì¼ì´ ì˜ ì „ì†¡ëë‹¤ê³  ë¯¿ì–´ë„ ì¶©ë¶„í•¨
- ì¦‰, í…ŒìŠ¤íŠ¸ìš© ë©”ì¼ ì„œë²„ë¥¼ ë§Œë“¤ì–´ í•´ë‹¹ ì„œë²„ê¹Œì§€ ì˜ ì „ë‹¬ì´ ë˜ëŠ”ì§€ë§Œ í™•ì¸

![https://blog.kakaocdn.net/dn/bSsWuV/btqDkyGF4kj/OYUkfLqnLyuOc0GN3UxxK0/img.png](https://blog.kakaocdn.net/dn/bSsWuV/btqDkyGF4kj/OYUkfLqnLyuOc0GN3UxxK0/img.png)

- SMTPë¼ëŠ” í‘œì¤€ ë©”ì¼ ë°œì†¡ í”„ë¡œí† ì½œë¡œ ë©”ì¼ ì„œë²„ì— ìš”ì²­ì´ ì „ë‹¬ë§Œ ë˜ë©´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê²ƒì„
- ë” ë‚˜ì•„ê°€, **UserService**ì™€ **JavaMail** ì‚¬ì´ì—ë„ ì ìš©í•  ìˆ˜ ìˆìŒ
- JavaMail APIì€ **ìë°”ì˜ í‘œì¤€ ê¸°ìˆ **ì´ê³ , ìˆ˜ë§ì€ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš© ë° ê²€ì¦ëœ ëª¨ë“ˆì„
- ì¦‰, JavaMailë¥¼ í†µí•´ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ë³´ì¥ë§Œ ìˆìœ¼ë©´ êµ³ì´ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œë§ˆë‹¤ ì‹¤ì œ JavaMailì„ êµ¬ë™í•  í•„ìš”ê°€ ì—†ìŒ

![https://gunju-ko.github.io//assets/img/posts/toby-spring/%EB%A9%94%EC%9D%BCTest.png](https://gunju-ko.github.io//assets/img/posts/toby-spring/%EB%A9%94%EC%9D%BCTest.png)

5.4.4 JavaMailì„ ì´ìš©í•œ í…ŒìŠ¤íŠ¸ì˜ ë¬¸ì œì  í•´ê²°ë°©ì•ˆ

- JsavaMailì˜ í•µì‹¬ APIì—ëŠ” ì¸í„°í˜ì´ìŠ¤ë¡œ ë§Œë“¤ì–´ì ¸ì„œ êµ¬í˜„ì„ ë°”ê¿€ ìˆ˜ ì—†ìŒ(?)
- JavaMailì€ Session í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ë©”ì¼ ë©”ì‹œì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŒ
- Sessionì€ ì¸í„°í˜ì´ìŠ¤ê°€ ì•„ë‹Œ í´ë˜ìŠ¤ë¡œ, ìƒì„±ìê°€ ëª¨ë‘ private ì—¬ì„œ ì§ì ‘ ìƒì„± ë¶ˆê°€í•¨
- Sessionì€ ìŠ¤íƒœí‹± íŒ©í† ë¦¬ ë©”ì†Œë“œë¥¼ ì´ìš©í•´ì•¼ë§Œ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŒ
    
    ```java
    Session s = Session.getInstance(props, null);
    ```
    
- Session í´ë˜ìŠ¤ëŠ” ìƒì†ì´ ë¶ˆê°€ëŠ¥í•œ final í´ë˜ìŠ¤ì„
- ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ëŠ” `MailMessage`ì™€ ì „ì†¡ì„ ë‹´ë‹¹í•˜ëŠ” `Transport`ë„ Sessionê³¼ ë§ˆì°¬ê°€ì§€ì„
- JavaMailì˜ êµ¬í˜„ì„ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë°”ê¿”ì¹˜ê¸° í•˜ëŠ”ê²ƒì€ ë§¤ìš° ì–´ë ¤ì›€
- ë¬¼ë¡ , JavaMailì²˜ëŸ¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° í˜ë“  êµ¬ì¡°ì˜ APIë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ì¢‹ê²Œ ë§Œë“œëŠ” ë°©ë²•ì´ ìˆìŒ
- **ì„œë¹„ìŠ¤ ì¶”ìƒí™”**ë¥¼ ì´ìš©í•˜ë©´ ë¨
- ìŠ¤í”„ë§ì—ì„œ JavaMailì˜ ë¬¸ì œì ì„ í•´ê²°í•œ JavaMailì— ëŒ€í•œ **ì¶”ìƒí™” ê¸°ëŠ¥** ì œê³µí•˜ê³  ìˆìŒ

```java
implementation group: 'javax.mail', name: 'com.springsource.javax.mail', version: '1.4.0'
implementation group: 'org.springframework', name: 'spring-context-support', version: '3.0.7.RELEASE'
compileOnly group: 'javax.activation', name: 'com.springsource.javax.activation', version: '1.1.0'
```

```java
//mail ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¡´ì¬
package org. springframework.mail;

public interface MailSender{
	void send(SimpleMailMessage simpleMessage) throws MailException;
	void send(SimpleMailMessage[] simpleMessages) throws MailException;
}
```

5.4.5 ìŠ¤í”„ë§ì˜ MailSenderë¥¼ ì´ìš©í•œ ë©”ì¼ ë°œì†¡ ë©”ì†Œë“œ

- JavaMailSender êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•œ ë©”ì¼ ë°œì†¡ìš© ì½”ë“œì„
- JavaMailì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì— ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ì¸ MailExceptionìœ¼ë¡œ í¬ì¥í•¨
- try/catchë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¨
- í•˜ì§€ë§Œ, ì•„ì§ JavaMail APIë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í…ŒìŠ¤íŠ¸ìš© ì˜¤ë¸Œì íŠ¸ë¡œ ëŒ€ì²´í•  ìˆ˜ ì—†ìŒ

```java
public void sendUpdateEmail(User user){
		JavaMailSenderImpl mailSender = new JavaMailSenderImpl();
		mailSender.setHost("mail.server.com");

		SimpleMailMessage mailMessage = new SimpleMailMessage();
		mailMessage.setTo("user.getEmail()");
    mailMessage.setFrom("useradmin@ksug.org");
    mailMessage.setSubject("Upgrade ì•ˆë‚´");
    mailMessage.setText("ì‚¬ìš©ìë‹˜ì˜ ë“±ê¸‰ì´"+user.getLevel().name());

    mailSender.send(mailMessage);
}
```

5.4.6 ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ ì¶”ìƒí™”

- ìŠ¤í”„ë§ì˜ DI ì ìš©
- JavaMailSenderImpl í´ë˜ìŠ¤ê°€ êµ¬í˜„í•œ MailSender ì¸í„°í˜ì´ìŠ¤ë§Œ ë‚¨ê¹€

```java
public class UserService {
		...
		private MailSender mailSender;

		public void setMailSender(MailSender mailSender) {
        this.mailSender = mailSender;
    }

		private void sendUpdateEmail(User user){
        SimpleMailMessage mailMessage = new SimpleMailMessage();
        mailMessage.setTo("user.getEmail()");
        mailMessage.setFrom("useradmin@ksug.org");
        mailMessage.setSubject("Upgrade ì•ˆë‚´");
        mailMessage.setText("ì‚¬ìš©ìë‹˜ì˜ ë“±ê¸‰ì´"+user.getLevel().name());

        this.mailSender.send(mailMessage);
    }
		...
}
```

```xml
<beans
		...>
		<bean id="userService" class="com.ksb.spring.UserService">
        <property name="userDao" ref="userDao"/>
        <property name="transactionManager" ref="transactionManager" />
        <property name="mailSender" ref="mailSender"/>
    </bean>

		<bean id="mailSender"
          class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="mail.server.com"/>
    </bean>
		...
</beans>
```

5.4.7 í…ŒìŠ¤íŠ¸ìš© ë©”ì¼ ë°œì†¡ ì˜¤ë¸Œì íŠ¸

- ìŠ¤í”„ë§ì´ ì œê³µí•œ ë©”ì¼ ì „ì†¡ ê¸°ëŠ¥ì— ëŒ€í•œ ì¸í˜ì´ìŠ¤(MailSender)ê°€ ìˆìœ¼ë‹ˆ ì´ë¥¼ êµ¬í˜„í•œ ë©”ì¼ í…ŒìŠ¤íŠ¸ìš© ë©”ì¼ ì „ì†¡ í´ë˜ìŠ¤(DummyMailSender) ìƒì„±
- XMLì—ì„œ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ `DummyMailSender`ë¡œ ë³€ê²½
- `DummyMailSender`ë¥¼ ì´ìš©í•œ ë©”ì¼ì€ ë©”ì¼ ì„œë²„ë¡œ ë°œì†¡ë˜ì§€ëŠ” ì•ŠìŒ
- `DummyMailSender`ëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
- ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ `JavaMail` APIë¡œ ì „ì†¡ë˜ë©´ ë©”ì¼ì´ ì‹¤ì œ ì „ì†¡ ë  ê²ƒìœ¼ë¯€ë¡œ, `DummyMailSender`ë¡œ ëŒ€ì²´í•˜ì—¬ ë©”ì¼ì´ ì „ì†¡ë˜ì§€ ì•Šê²Œ í•¨
- `DummyMailSender`ëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šì§€ë§Œ, ê°€ì¹˜ëŠ” ë§¤ìš° í¼
- `DummyMailSender`ë¡œ ë©”ì¼ì„ ì§ì ‘ ë°œì†¡í•˜ëŠ” JavaMailì„ ëŒ€ì²´í•˜ì§€ ì•Šìœ¼ë©´ í…ŒìŠ¤íŠ¸ëŠ” ë§¤ìš° ë¶ˆí¸í•´ ì§ˆê²ƒì„

```java
public class DummyMailSender implements MailSender {
    @Override
    public void send(SimpleMailMessage simpleMessage) throws MailException {   
    }
    @Override
    public void send(SimpleMailMessage[] simpleMessages) throws MailException {
    }
}

public class UserServiceTest {
		@Autowired
    MailSender mailSender;
		...
		@Test
    public void upgradeAllOrNothing() {
				testUserService.setMailSender(this.mailSender); //ìˆ˜ë™ DI
				...
		}
}
```

```xml
<beans
		...>
		...
		<bean id="mailSender"
          class="com.ksb.spring.DummyMailSender">
		...
</beans>
```

5.4.8 í…ŒìŠ¤íŠ¸ì™€ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ì„œë¹„ìŠ¤ ì¶”ìƒí™”ë€, ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤ì™€ ì¼ê´€ì„± ìˆëŠ” ì ‘ê·¼ ë°©ë²•ì„ ì œê³µí•´ ì£¼ëŠ” ê²ƒì„
- ìŠ¤í”„ë§ì´ ì§ì ‘ ì œê³µí•˜ëŠ” `MailSender`ë¥¼ êµ¬í˜„í•œ ì¶”ìƒí™” í´ë˜ìŠ¤ëŠ” `JavaMailServiceImpl` **í•˜ë‚˜ ë¿**ì„
- ë‹¤ì–‘í•œ íŠ¸ëœì­ì…˜ ê¸°ìˆ ì— ëŒ€í•´ ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ê²ƒê³¼ **ëŒ€ë¹„**ë¨
    
    <aside>
    ğŸ’¡ ì¼ë°˜ì ì¸ ì¶”ìƒí™”ëŠ” ì—¬ëŸ¬ í´ë˜ìŠ¤ ì¤‘ ê³µí†µì ì¸ ë¶€ë¶„ì„ ì¶”ì¶œí•´ ë§Œë“œëŠ” ê²ƒì„
    
    </aside>
    
- ëŒ€ë¹„ëœë‹¤ í•˜ë”ë¼ë„, ì¶”ìƒí™”ëœ ë©”ì¼ ì „ì†¡ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‘ì„í•¨ìœ¼ë¡œì¨ ì–»ì„ ìˆ˜ ìˆëŠ” ì¥ì ì€ ë§¤ìš° í¼
- ë‹¤ë¥¸ ë©”ì‹œì§• ì„œë²„ì˜ APIë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ í•´ë‹¹ APIë¥¼ ì´ìš©í•˜ëŠ” MailSender êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ DI í•´ì£¼ë©´ ë¨
- ë˜í•œ, ë©”ì¼ì„ ë°”ë¡œ ì „ì†¡í•˜ì§€ ì•Šê³  **í**ì— ë‹´ì•„ì„œ ì¼ê´„ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ
- ì–´ë– í•œ ê²½ìš°ì—ë„ UserServiceëŠ” ë©”ì¼ì„ ë°œì†¡í•œë‹¤ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë³€í•˜ì§€ ì•ŠëŠ”ì´ìƒ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ìŒ

[https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FboEqwa%2FbtqDliXFKKg%2FZ002jfQKNxitZXxRKeZPy1%2Fimg.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FboEqwa%2FbtqDliXFKKg%2FZ002jfQKNxitZXxRKeZPy1%2Fimg.png)

5.4.9 í˜„ì¬ ë©”ì¼ ë°œì†¡ ë¡œì§ì˜ ë¬¸ì œì 

- ë©”ì¼ ë°œì†¡ ë¡œì§ì— **íŠ¸ëœì­ì…˜** ê°œë…ì´ ë¹ ì ¸ìˆìŒ
- í•œ ìœ ì €ê°€ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œë˜ë©´ ë°”ë¡œ ë©”ì¼ì„ ë³´ë‚´ê¸° ë•Œë¬¸ì— ì—…ê·¸ë ˆì´ë“œ ì‘ì—… ì¤‘ê°„ì— DBì— ë¬¸ì œê°€ ìƒê²¨ ë¡¤ë°±ì„ í•´ë„ ì´ë¯¸ ë°œì†¡ëœ ë©”ì¼ì„ ì·¨ì†Œí•  ìˆ˜ ì—†ìŒ
- í•´ê²°ì— **ë‘ ê°€ì§€** ë°©ë²•ì´ ìˆìŒ
- ì²« ë²ˆì§¸, ì—…ê·¸ë ˆì´ë“œ í•  ë•Œë§ˆë‹¤ ë©”ì¼ì„ ë³´ë‚´ì§€ ì•Šê³  ë³„ë„ì˜ ëª©ë¡ì— ì €ì¥ í›„ ì¼ê´„ì  ì „ì†¡
- ë‹¨ì ì€, ë©”ì¼ ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸ ë“±ì„ íŒŒë¼ë¯¸í„°ë¡œ ê³„ì† ê°–ê³  ë‹¤ë…€ì•¼ í•¨
- ë‘ ë²ˆì§¸, MailSenderë¥¼ í™•ì¥í•´ì„œ ë©”ì¼ ì „ì†¡ì— íŠ¸ëœì­ì…˜ ê°œë… ì ìš©
- ì²« ë²ˆì§¸ ë°©ë²•ì€ ì‚¬ìš©ì ê´€ë¦¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë©”ì¼ ë°œì†¡ì— íŠ¸ëœì­ì…˜ ê°œë…ì„ ì ìš©í•˜ëŠ” ê¸°ìˆ ì ì¸ ë¶€ë¶„ì´ í•œë° ì„ì¼ ìˆ˜ ë°–ì— ì—†ìŒ
- ë‘ ë²ˆì§¸ ë°©ë²•ì€ MailSenderì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ ì„œë¡œ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì‘ì—…ì„ ë¶„ë¦¬ ê°€ëŠ¥

5.4.10 ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì˜ ë³€ê²½ì„ í†µí•œ í…ŒìŠ¤íŠ¸ ë°©ë²•

- UserDaoTestëŠ” **ìš´ì˜ í™˜ê²½**ì—ì„œ DBì™€ ì—°ê²°ë˜ì–´ì„œ ë™ì‘í•¨
- ëŒ€ìš©ëŸ‰ DBì— ìµœì í™”ëœ ë³µì¡í•œ DataSourceì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì´ìš© ë° ëŒ€ìš©ëŸ‰ DB ì—°ê²° ê¸°ëŠ¥ì— ìµœì í™”ëœ WASì—ì„œ ë™ì‘í•˜ëŠ” DB í’€ë§ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•¨
- í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì´ëŸ° ê¸°ëŠ¥ì´ í•„ìš”ì—†ìŒ
- ë‹¨ìˆœí•œ DataSourceì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ê°€ë²¼ìš´ DBë§Œì„ ì‚¬ìš©í•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë„ ì¶©ë¶„í•¨
- ë§ˆì°¬ê°€ì§€ë¡œ **ìš´ì˜ í™˜ê²½**ì—ì„œ UserServiceëŠ” `JavaMailSenderImpl`ì™€ `JavaMail`ì„ ì´ìš©í•´ ë©”ì¼ ì„œë²„ì™€ ì—°ê²°í•¨
- í•˜ì§€ë§Œ, UserServiceëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ê³µí•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ì§€, ë©”ì¼ì´ ì–´ë–»ê²Œ ì „ì†¡ë  ê²ƒì¸ê°€ì— ëŒ€í•œ ê´€ì‹¬ì€ ì—†ìŒ
- ë•Œë¬¸ì— `JavaMail`ì„ `DummyMailSender`ë¥¼ ì´ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë„ ì›í• íˆ í…ŒìŠ¤íŠ¸ê°€ ì´ë¤„ì§€ë„ë¡ í•¨

[https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FSHBdh%2FbtqDoTIJOMA%2F6kOXHwpM5NAqE5rmijjlVk%2Fimg.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FSHBdh%2FbtqDoTIJOMA%2F6kOXHwpM5NAqE5rmijjlVk%2Fimg.png)

<aside>
ğŸ’¡ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì˜ ë³€ê²½ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ê°€ ì›í™œí•´ì§

</aside>

5.4.11 ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ë˜ëŠ” í˜‘ë ¥ ì˜¤ë¸Œì íŠ¸

- í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ë˜ëŠ” ì˜¤ë¸Œì íŠ¸ê°€ ë˜ ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì— ì˜ì¡´í•˜ëŠ” ì¼ì€ ë§¤ìš° í”í•¨
- UserServiceëŠ” `userDao`, `transactionManager`, `mailSender` ì„¸ ê°€ì§€ì— ì˜ì¡´í•˜ê³  ìˆìŒ
- ì˜ì¡´í•œë‹¤ëŠ” ê²ƒì€ **ì¢…ì†**ë˜ê±°ë‚˜ **ê¸°ëŠ¥ ì‚¬ìš©**ì„ í•œë‹¤ëŠ” ì˜ë¯¸ì„
- ì‘ì€ ê¸°ëŠ¥ì´ë¼ë„ ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ìì‹ ì´ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì˜ì¡´í•˜ê³  ìˆë‹¤ëŠ” ë§í•˜ëŠ” ê²ƒì„
- ì˜ì¡´ì„ í†µí•´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì™€ í˜‘ë ¥í•´ ì¼ì„ ì²˜ë¦¬í•¨
- ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ **í˜‘ë ¥ ì˜¤ë¸Œì íŠ¸(Collaborator Object)**ë¼ê³ ë„ í•¨
- í…ŒìŠ¤íŠ¸ ëŒ€ìƒì¸ ì˜¤ë¸Œì íŠ¸ê°€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ ë„ˆë¬´ ê±°ì°½í•œ ì‘ì—…ì´ ë’¤ë”°ë¥´ëŠ” ê²½ìš°ê°€ ë°œìƒí•¨
- ë•Œë¬¸ì— ê±°ì°½í•œ ì‘ì—…ì„ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ê°„ë‹¨í•œ ì‘ì—…ìœ¼ë¡œ ëŒ€ì¹˜í•˜ì—¬ ì²˜ë¦¬í•¨
- í…ŒìŠ¤íŠ¸ìš© XMLì„ ë”°ë¡œ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©ì„ í•˜ë©´, DIë¥¼ í†µí•´ ê°„ë‹¨íˆ í…ŒìŠ¤íŠ¸ ìš©ìœ¼ë¡œ ì‘ì—…ì„ ëŒ€ì¹˜í•  ìˆ˜ ìˆìŒ

5.4.12 í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì˜ ì¢…ë¥˜ì™€ íŠ¹ì§•

- í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double)ì´ë€, í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ë˜ëŠ” ì˜¤ë¸Œì íŠ¸ì˜ ê¸°ëŠ¥ì—ë§Œ ì¶©ì‹¤í•˜ê²Œ ìˆ˜í–‰í•˜ë©´ì„œ ë¹ ë¥´ê²Œ, ìì£¼ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œí–‰í•  ìˆ˜ ì‡ë„ë¡ í•˜ëŠ” ì˜¤ë¸Œì íŠ¸
- UseDaoì˜ DataSource êµ¬í˜„ì²´ì¸ `SimpleDriverDataSource`ë‚˜, UserServiceì˜ MailSender êµ¬í˜„ì²´ì¸ `DummyMailSender`ê°€ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì˜ ì˜ˆì‹œì„
- í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì˜ ëŒ€í‘œì ì¸ **ë‘ ê°€ì§€** ë°©ë²•
    1. í…ŒìŠ¤íŠ¸ ìŠ¤í…(Test Stub)
        - ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì— ê°„ì ‘ì ì¸ ì…ë ¥ ì œê³µ
    2. ëª© í…ŒìŠ¤íŠ¸(Mock Test)
        - ìŠ¤í… ì˜¤ë¸Œì íŠ¸ì™€ ê°„ì ì ì¸ ì¶œë ¥ í™•ì¸
    

5.4.13 í…ŒìŠ¤íŠ¸ ìŠ¤í…

- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì˜ ì˜ì¡´ê°ì²´
- í…ŒìŠ¤íŠ¸ ë™ì•ˆ ì½”ë“œê°€ ì •ìƒì ì„ ìˆ˜í•¼í•  ìˆ˜ ìˆë„ë¡ ë„ì›€
- `DummyMailSender`ëŠ” ê°€ì¥ ì‹¬í”Œí•œ í…ŒìŠ¤íŠ¸ ìŠ¤í…ì˜ ì˜ˆì‹œì„
- í…ŒìŠ¤íŠ¸ ìŠ¤í…ì€ `MailSender` ì²˜ëŸ¼ í˜¸ì¶œí•˜ë©´ ê·¸ë§Œì¸ ê²ƒë„ ìˆì§€ë§Œ, ê²°ê³¼ë¥¼ ë¦¬í„´í•´ì•¼ í•  ë•Œê°€ ìˆìŒ
- ì´ëŸ´ ë•ŒëŠ” í…ŒìŠ¤íŠ¸ ì¤‘ì— í•„ìš”í•œ ì •ë³´ë¥¼ ë¦¬í„´í•˜ë©´ ë¨
- ë˜ëŠ” ê°•ì œì ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œì¼œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì˜ ì˜¤ë¸Œì íŠ¸ê°€ ì˜ˆì™¸ìƒí™©ì— ì–´ë–¤ ë°˜ì‘ì„ ë³´ì´ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ë•Œ ì ìš©í•  ìˆ˜ ìˆìŒ
- ìŠ¤í…ì„ ì´ìš©í•˜ë©´ ê°„ì ‘ì ì¸ ì…ë ¥ ê°’ ì§€ì • ë° ê°„ì ‘ì  ì¶œë ¥ ê°’ì„ ë°›ê²Œ í•  ìˆ˜ ìˆìŒ
- `DummyMailSender`ëŠ” í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸ì—ê²Œ ëŸ¬í„´ì€ ì•ˆí•˜ì§€ë§Œ, UserServiceë¡œ ë¶€í„° ì „ë‹¬ë°›ëŠ” ê²ƒì€ ìˆìŒ

5.4.14 ëª© í…ŒìŠ¤íŠ¸

- ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì— ë„˜ê¸°ëŠ” **ê°’ê³¼ í–‰ìœ„** ìì²´ë¥¼ ê²€ì¦í•  ë•Œ ì‚¬ìš©
- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì™€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì˜ ë°œìƒí•˜ëŠ” ì¼ì„ ê²€ì¦í•  ìˆ˜ ìˆìŒ

[https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAkSOC%2FbtqDlM5mQlc%2F5EKdbEEnMPmxLB7xOlR0Y0%2Fimg.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FAkSOC%2FbtqDlM5mQlc%2F5EKdbEEnMPmxLB7xOlR0Y0%2Fimg.png)

- ìœ„ ê·¸ë¦¼ì—ì„œ (5)ì„ ì œì™¸í•˜ê³ ëŠ” **ìŠ¤í…**ì´ë¼ í•´ë„ ë¨
- **í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸**ëŠ” í…ŒìŠ¤íŠ¸ì˜ **ì…ë ¥** ë° **ì˜ì¡´ ì˜¤ë¸Œì íŠ¸**ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì´ ë°œìƒë¨
- í…ŒìŠ¤íŠ¸ ëŒ€ìƒì€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ì—ê²Œ ê°’ì„ ì…ë ¥ ë° ì¶œë ¥ì„ ë°›ê¸°ë„ í•¨

5.4.15 ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ì´ìš©í•œ í…ŒìŠ¤íŠ¸

- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ì˜ ë©”ì†Œë“œ í˜¸ì¶œì´ ëë‚˜ë©´ í…ŒìŠ¤íŠ¸ëŠ” ëª© ì˜¤ë¸Œì íŠ¸ì—ê²Œ í…ŒìŠ¤íŠ¸ ëŒ€ìƒê³¼ ëª© ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì— ì¼ì–´ë‚¬ë˜ ì¼ì— ëŒ€í•´ í™•ì¸ ìš”ì²­ì„ í•˜ì—¬ í…ŒìŠ¤íŠ¸ ê²€ì¦ ìë£Œë¡œ ì‚¬ìš©
- UserServiceTestì˜ `upgradeAllOrNothing()`ëŠ” ë©”ì¼ì´ ì „ì†¡ ëëŠ”ì§€ì— ëŒ€í•œ ê´€ì‹¬ì´ ì—†ìŒ
- ë°˜ë©´ UserServiceì—ì„œëŠ” ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‹œ ë©”ì¼ì´ ì „ì†¡ë˜ì•¼ í•˜ë¯€ë¡œ ë©”ì¼ ì „ì†¡ì— ëŒ€í•´ ê´€ì‹¬ì´ ìˆìŒ
- ë§Œì•½ `JavaMail`ì„ `DummyMailSender`ë¡œ ëŒ€ì²´í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¼ì¼íˆ ë©”ì¼ ë°œì†¡ì— ëŒ€í•´ í™•ì¸ì„ í•´ì•¼í•¨
- í•˜ì§€ë§Œ, JavaMail ì„œë¹„ìŠ¤ë¥¼ ì¶”ìƒí™” í–ˆê¸° ë•Œë¬¸ì— ëª© ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ë©”ì¼ ë°œì†¡ ì—¬ë¶€ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆìŒ
- MockMailSenderì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ë¶€í„° UserService ì‚¬ì´ì— ì¼ì–´ë‚œ ì¼ì„ ê²€ì¦(ëª© í…ŒìŠ¤íŠ¸)í•  ìˆ˜ ìˆìŒ
- userServiceì— DI í•´ì¤¬ë˜ ëª© ì˜¤ë¸Œì íŠ¸ë¡œ ë¶€íŠ¸ getRequestsë¥¼ í˜¸ì¶œí•˜ê³  ì´ë¥¼ ë¹„êµí•˜ì—¬ í–‰ìœ„ ìì²´ë¥¼ ê²€ì¦í•¨

```java
public class MockMailSender implements MailSender {
		//UserServiceë¡œ ë¶€í„° ì „ì†¡ ìš”ì²­ì„ ë°›ì€ ë©”ì¼ ì£¼ì†Œë¥¼ ì €ì¥í•´ ì½ì„ ìˆ˜ ìˆê²Œ í•¨
    private List<String> requests = new ArrayList<>();
    public List<String> getRequests(){
        return requests;
    }
    @Override
    public void send(SimpleMailMessage simpleMessage) throws MailException {
        requests.add(simpleMessage.getTo()[0]);
    }
    @Override
    public void send(SimpleMailMessage[] simpleMessages) throws MailException {

    }
}

//ì£¼ì„ ë¶€ë¶„ì´ ì¶”ê°€í•œ ê²ƒì„
public class UserServiceTest {
		...
		@Test
    //@DirtiesContext //DI ì„¤ì •ì„ ë³€ê²½í•œë‹¤ê³  ì•Œë¦¼
    public void upgradeLevels() {
        userDao.deleteAll();
        for (User user : users) userDao.add(user);

//        MockMailSender mockMailSender = new MockMailSender();
//        userService.setMailSender(mockMailSender);

        userService.upgradeLevels();

        checkLevelUpgraded(users.get(0), false);
        checkLevelUpgraded(users.get(1), true);
        checkLevelUpgraded(users.get(2), false);
        checkLevelUpgraded(users.get(3), true);
        checkLevelUpgraded(users.get(4), false);

        //List<String> request = mockMailSender.getRequests();
        //assertThat(request.size(), is(2)); //2,4ì´ ì—…ê·¸ë ˆì´ë“œ ì´ë¯€ë¡œ ì´ 2ë²ˆ
        //assertThat(request.get(0), is(users.get(1).getEmail()));
        //assertThat(request.get(0), is(users.get(1).getEmail()));
    }
}
```